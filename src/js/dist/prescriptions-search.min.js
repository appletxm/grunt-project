var mock_result={data:[{result:[],totalCount:1,totalPages:3,pageNo:1}],msg:"success",code:0},mock_return={data:["搜索药品1","搜索药品2","搜索药品1搜索药品1搜索药品1"],msg:"success",code:0},prescriptionsSearch={ajax:null,popWindow:null,messageBox:null,searchFromDatabase:null,requestUrl:SYS_VAR.SERVER_ADDRESS,scrollPage:0,key:"",page:1,totalPages:0,num:20,orderBy:"default",order:0,isFirstLoad:!0,urlParameters:{},selectedList:[],init:function(){this.ajax=new Ajax,this.messageBox=new MessageBox,this.popWindow=new PopWindow,this.searchFromDatabase=new SearchFromDatabase,this.searchFromDatabase.init({ajax:this.ajax,tipList:{action:this.requestUrl+"doc/search_list/"},callback:this.handleDoSearch.bind(this),messageBox:this.messageBox,beforeSearchFunction:this.resetPageInfo.bind(this),pageObj:prescriptionsSearch,pageObjString:"prescriptionsSearch",searchObjString:"searchFromDatabase",bindObj:document.querySelector("#searchBinObj"),tipText:"输入药品名称搜索"}),this.attachEvent(),this.getUrlParameters()},getUrlParameters:function(){var a,b,c=window.location.search;if(!c||""===c)return!1;if(b=c.getValueFromUrl(),this.urlParameters=b,1===this.urlParameters.flag||"1"===this.urlParameters.flag){if(this.urlParameters.medication_ids&&""!==this.urlParameters.medication_ids&&"null"!==this.urlParameters.medication_ids&&"undefined"!==this.urlParameters.medication_ids){a=this.urlParameters.medication_ids.split(",");for(var d=0;d<a[d];d++)this.selectedList.push(parseInt(a[d],10))}document.title=this.urlParameters.group_name+"　"||"分组名"}else this.getFavoriteMedicine()},getFavoriteMedicine:function(){var a={sendParameters:{page:1,num:500}};a.url=this.requestUrl+"doc/medication_box/",a.type="GET",a.asyn=!0,a.onSuccess=this.handleGetFavoriteMedicineSuccess.bind(this),a.onError=this.handleGetError.bind(this),this.showLoading(),this.ajax.send(a)},handleGetFavoriteMedicineSuccess:function(a){0===a.code||"0"===a.code?(this.getMedicineIds(a.data),this.hideLoading()):this.getMedicineIds([])},getMedicineIds:function(a){var b=[],c=[];if(a.length>0)for(var d=0;d<a.length;d++)b=b.concat(a[d].voList);for(var e=0;e<b.length;e++)c.push(b[e].id);this.urlParameters.medication_ids=c.join(",")},handleDoSearch:function(a){if(this.key=a||this.searchFromDatabase.key,!this.key||""===this.key.trim())return this.messageBox.show({msg:"请输入搜索关键字",type:"alert",autoClose:!0}),!1;var b={sendParameters:{doctorId:this.doctorId,key:this.key,page:this.page,num:this.num,orderBy:this.orderBy,order:this.order}};b.url=this.requestUrl+"doc/search_medication/",b.type="GET",b.asyn=!0,b.onSuccess=this.handleGetPatientMedicalSuccess.bind(this),b.onError=this.handleGetError.bind(this),this.showLoading(),this.ajax.send(b),this.isFirstLoad=!1},handleGetPatientMedicalSuccess:function(a){var b,c,d=document.querySelector("#medicalSearchList");if(0===a.code)if(this.hideLoading(),a.data&&a.data.length>0){if(b=a.data[0].result,0===b.length)return this.handleGetError({msg:"没有找到您要想的药品~"}),!1;if(this.totalPages=a.data[0].totalPages,c=this.getListHtml(b,1),1===this.page)d.innerHTML=c;else{var e=document.createElement("span");e.innerHTML=c,d.appendChild(e)}1===this.page&&setTimeout(function(){document.querySelectorAll("body")[0].scrollTop=0,window.onscroll=function(a){this.handleScroll(a)}.bind(this)}.bind(this),0)}else this.handleGetError({msg:"没有找到您要想的药品~"});else this.handleGetError(a)},getListHtml:function(a){var b=[];if(a.length>0)for(var c=0;c<a.length;c++){var d,e,f,g,h="添加到常用药",i="add-store",j=a[c].skus[0].skuId,k=[];1==a[c].added&&(h="已经添加",i="add-store add-store-success"),e=a[c].name&&""!==a[c].name&&"null"!==a[c].name&&"undefined"!==a[c].name?a[c].name:"药品",a[c].commonName&&""!==a[c].commonName&&"null"!==a[c].commonName&&"undefined"!==a[c].commonName&&(e+="（"+a[c].commonName+"）"),f='onclick="prescriptionsSearch.handleSearchListClick(event);"',d='class="add-recommond"',"0"===this.urlParameters.flag?(a[c].added===!0||"true"===a[c].added)&&(d='class="add-recommond selected"'):this.checkMedicineInPrescription(a[c].id)&&(d='class="add-recommond selected"'),g="../medical/medical-detail.html?medicalId="+a[c].id+"&isAdded="+(a[c].added||!0),k.push("<span "+d+' id="add-recommond-'+a[c].id+'"'),k.push(' hasAddToStore="0" productId="'+a[c].id+'"'),k.push(' usage="'+encodeURIComponent(a[c].usage||"")+'"'),k.push(' spec="'+encodeURIComponent(a[c].spec||"")+'"'),k.push(' skuId="'+j+'"'),k.push(' productSize="'+encodeURIComponent(a[c].usage||"")+'"'),k.push(' productName="'+encodeURIComponent(a[c].name||"")+'"'),k.push(' commonName="'+encodeURIComponent(a[c].commonName||"")+'"></span>'),b.push("<dl "+f+">"),b.push('<dt><a href="'+g+'">'),b.push('<img src="'+a[c].image+'?s=t" width="100" />'),b.push("</a>"),b.push("</dt>"),b.push("<dd>"),b.push('<i class="tit">'+e+"</i>"),b.push('<i class="size">'+(a[c].manufacturer||a[c].usage)+"</i>"),b.push("<b>¥"+a[c].salePrice+"</b>"),b.push(k.join("")),b.push("</dd>"),b.push("</dl>")}else b.push('<div class="no-data-tip"></div>');return b.join("")},handleGetError:function(a,b,c){var d=a.msg;b===!0?this.selectedList.splice(this.selectedList.indexOf(c),1):b===!1&&this.selectedList.push(c),a.msg&&""!==a.msg||(d="网络异常，请稍后再试"),this.messageBox.show({msg:d,type:"alert",autoClose:!0})},handleSearchListClick:function(a){var b,c=a.target,d=c.tagName.toLowerCase();"a"!==d&&"img"!==d&&"dt"!==d&&(a.preventDefault(),b=a.currentTarget.querySelectorAll(".add-recommond")[0],this.editMedicineFromList(b,c))},editMedicineFromList:function(a){var b;b=parseInt(a.getAttribute("productId"),10),a.className.indexOf("selected")>=0?(this.selectedList.splice(this.selectedList.indexOf(b),1),this.handleSaveEvent(a,!1,b)):(this.selectedList.push(b),this.handleSaveEvent(a,!0,b))},handleFilterBar:function(a){var b=a.target;if(!(b.className.indexOf("selected")>=0)){for(var c=b.parentNode.querySelectorAll("li"),d=0;d<c.length;d++)c[d]===b?b.className="selected":c[d].className.indexOf("selected")>=0&&(c[d].className="");this.orderBy=b.getAttribute("type"),this.handleDoSearch()}},handleScroll:function(){var a=document.querySelectorAll("body")[0];return this.isFirstLoad===!0?!1:void(a.scrollTop===a.scrollHeight-document.documentElement.clientHeight&&(this.page++,this.page<=this.totalPages?this.handleDoSearch():this.page=this.totalPages))},resetPageInfo:function(){window.onscroll=null,this.page=1},checkMedicineInPrescription:function(a){var b=this.urlParameters.medication_ids,c=new RegExp("("+a+")","g");return b&&b.match(c)&&b.match(c).length>0?!0:!1},handleSaveEvent:function(a,b,c){var d={sendParameters:{}};"1"===this.urlParameters.flag||1===this.urlParameters.flag?(d.url=this.requestUrl+(b?"doc/medication_group_add_medic/":"doc/medication_group_remove_medic/"),d.sendParameters.id=this.urlParameters.group_id,b===!0?d.sendParameters.medicationIds=0===this.selectedList.length?c:this.selectedList.toString():d.sendParameters.medicationIds=c):(d.url=this.requestUrl+(b?"doc/medication_add_box/":"doc/medication_remove_box/"),d.sendParameters.pid=c),d.type="GET",d.asyn=!0,d.onSuccess=function(c){this.handleSaveListSuccess(c,a,b)}.bind(this),d.onError=function(a){this.handleGetError(a,b,c)}.bind(this),this.showLoading(),this.ajax.send(d)},handleSaveListSuccess:function(a,b,c){0===a.code||"0"===a.code?this.showResultTipMessage(b,c):this.handleGetError(a)},showResultTipMessage:function(a,b){b===!0?a.className="add-recommond selected":a.className="add-recommond",this.messageBox.show({msg:b?"添加成功！":"删除成功",type:"alert",autoClose:!0})},showLoading:function(){this.messageBox.show({msg:'<span class="fa fa-spinner fa-pulse fa-2x fa-fw"></span>',type:"loading",autoClose:!1})},hideLoading:function(){this.messageBox.hide()},attachEvent:function(){var a=document.querySelector("#filterBar");a.addEventListener("click",function(a){this.resetPageInfo(),this.handleFilterBar(a)}.bind(this)),window.onscroll=function(){this.handleScroll()}.bind(this)}};prescriptionsSearch.init();