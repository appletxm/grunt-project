var addCard={ajax:null,messageBox:null,popWindow:null,removeCardList:[],bankList:[],selectedBackInfo:{user:"",card:"",bank:{},branch:""},urlParameters:{},isModifyData:!1,init:function(){this.messageBox=new MessageBox,this.ajax=new Ajax,this.popWindow=new PopWindow,this.getUrlParameters(),this.attachEvent(),this.getUserInfo()},getUrlParameters:function(){var a=window.location.search.replace("?","");return a&&""!==a?(document.querySelectorAll("title")[0].innerHTML="修改银行卡",this.urlParameters=a.getValueFromUrl(),this.isModifyData=!0,void this.setDefaultValue(this.urlParameters)):!1},setDefaultValue:function(a){var b=document.querySelector("#cardNo");document.querySelector("#chooseBank").innerHTML='<dt>银行卡</dt><dd id="bank"><input readonly value="'+(a.name||"")+'" /></dd>',b.setAttribute("readonly","true"),b.setAttribute("value",a.bankCardNum),this.selectedBackInfo.name=a.name,this.selectedBackInfo.id=a.userBankId,this.selectedBackInfo.card=a.bankCardNum},getUserInfo:function(){var a={};a.url=SYS_VAR.SERVER_ADDRESS+"doc/get_info/",a.type="GET",a.asyn=!0,a.sendParameters={},a.onSuccess=this.handleGetUserInfoSuccess.bind(this),a.onError=this.handleError.bind(this),a.mssage=this.messageBox,this.ajax.send(a)},handleGetUserInfoSuccess:function(a){0===a.code?document.querySelector("#useName").value=a.data[0].name:this.handleError(a)},addNewCard:function(){var a=this.doValidate();if(a.res!==!0)return this.messageBox.show({msg:a.msg,type:"alert",autoClose:!0}),!1;var b={};b.url=SYS_VAR.SERVER_ADDRESS+"doc/add_bank/",b.type="GET",b.asyn=!0,b.sendParameters={bankCardNum:a.cardNo,branch:a.branch,userType:1},this.isModifyData===!0?(b.url=SYS_VAR.SERVER_ADDRESS+"doc/edit_bank/",b.sendParameters.userBankId=this.selectedBackInfo.id):(b.sendParameters.name=a.user,b.sendParameters.bId=this.selectedBackInfo.id),b.onSuccess=this.addBankSuccess.bind(this),b.onError=this.handleError.bind(this),b.mssage=this.messageBox,this.ajax.send(b)},doValidate:function(){var a=document.querySelector("#useName").value,b=document.querySelector("#cardNo").value,c=document.querySelector("#branch").value;if(!a||""===a||!a.isNormalText(2,16))return{res:!1,msg:"没有获取到有效的用户名，请稍后重试"};if(this.isModifyData!==!0){if(!this.selectedBackInfo.name||""===this.selectedBackInfo.name)return{res:!1,msg:"请选择银行"};if(!b||""===b||!b.isNumber(16,30))return{res:!1,msg:"请输入正确的银行卡号"}}return c&&""!==c&&c.isNormalText(5)?{res:!0,msg:"",user:a,cardNo:b,branch:c}:{res:!1,msg:"请输入正确的开户行信息"}},showBankList:function(a){var b={buttons:[],space:{}};b.needMask=!0,b.title="选择银行",b.space={top:50,left:20},b.content=a,b.buttons.push({text:"取 消",css:"cancel x1",callback:"addCard.cancelSelectBankCallback()"}),this.popWindow.show(b),this.messageBox.hide()},selectedBankCallback:function(a){var b=a.currentTarget;this.selectedBackInfo.id=b.getAttribute("bId"),this.selectedBackInfo.bCode=b.getAttribute("bCode"),this.selectedBackInfo.name=b.getAttribute("bank"),document.querySelector("#bank").innerText=this.selectedBackInfo.name,this.popWindow.hide()},cancelSelectBankCallback:function(){this.popWindow.hide()},getBankList:function(){if(this.bankList.length>0){var a=this.getBankListHtml(this.bankList);return void this.showBankList(a)}var b={};b.url=SYS_VAR.SERVER_ADDRESS+"doc/support_banks/",b.type="GET",b.asyn=!0,b.onSuccess=this.getBankListSuccess.bind(this),b.onError=this.handleError.bind(this),b.mssage=this.msessageBox,this.ajax.send(b)},getBankListHtml:function(a){for(var b='<div class="my-card" style="padding-bottom:0;"><div class="my-time card-list">',c=0;c<a.length;c++)b+='<dl bId="'+a[c].bId+'" bCode="'+a[c].bCode+'" onclick="addCard.selectedBankCallback(event)" bank="'+a[c].bName+'""><dt><img src="'+a[c].bIcon+'" height="40" /></dt><dd>'+a[c].bName+"</dd></dl>";return b+="</div></div>"},getBankListSuccess:function(a){var b="";0===a.code?(this.bankList=a.data,b=this.getBankListHtml(this.bankList),this.showBankList(b)):this.handleError(a)},addBankSuccess:function(a){0===a.code?this.isModifyData===!0?window.location.href="point-cash.html":window.location.href="point-card.html":this.handleError(a)},handleError:function(a){this.messageBox.show({msg:a.msg,type:"alert",autoClose:!0})},attachEvent:function(){var a=document.querySelector("#chooseBank"),b=document.querySelector("#addNewCard");a.addEventListener("click",function(){this.getBankList()}.bind(this),!1),b.addEventListener("click",function(){this.addNewCard()}.bind(this),!1)}};addCard.init();