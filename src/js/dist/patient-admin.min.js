var abcSideBar={messageBox:null,pageObj:null,init:function(a){a&&(this.pageObj=a.pageObj,this.messageBox=a.pageObj.messageBox)},showABCSideBar:function(a){var b,c,d,e=a.list||[],f=a.bindObj;return a.list.length<=1?!1:(b=document.createElement("span"),b.className=a.css||"abc-side-bar-outer",b.setAttribute("id","abcSideBarOuter"),c=document.createElement("div"),c.className="abc-side-bar-mask",d=document.createElement("span"),d.innerHTML=this.getSideBarHtml(e).join(""),b.appendChild(c),b.appendChild(d),void f.appendChild(b))},getSideBarHtml:function(a){var b,c=[];return b=1/a.length*100+"%",c.push('<ul id="sideBarLit" class="abc-side-bar-list" ontouchstart="abcSideBar.slideBarScroll(event);" ontouchmove="abcSideBar.touchMoveScroll(event);">'),a.forEach(function(a){var d;d="#"===a?"other":a,c.push('<li style="height:'+b+';"><a for-id="ABC_key_'+d+'">'+a+"</a></li>")}),c.push("</ul>"),c},slideBarScroll:function(a){var b=a.target,c=b.tagName.toLowerCase();"a"===c&&this.doSlideBarScroll(b),a.stopPropagation(),a.preventDefault()},touchMoveScroll:function(a){var b=document.elementFromPoint(a.touches[0].clientX,a.touches[0].clientY);b&&"a"===b.tagName.toLowerCase()&&this.doSlideBarScroll(b),a.preventDefault(),a.stopPropagation()},doSlideBarScroll:function(a){var b=document.querySelector("#"+a.getAttribute("for-id"));b&&this.getTopForNavigator(b)},getTopForNavigator:function(a,b){var c=0;if(!b){var b={};b.top=0,b.left=0}b.top+=a.offsetTop-c,b.left+=a.offsetLeft,this.doNavigatorScroll(b)},doNavigatorScroll:function(a){var b=document.querySelector("#patient-list"),c=3;b.scrollTop=a.top+c}},mockGetLatestMessageList={data:[[[29,{patient_remark:"潜水的鱼备注",patient_name:"潜水的鱼",patient_id:29,last_time:1450942056e3,count:0,patient_img:"http://wx.qlogo.cn/mmopen/K8iaLV5wicvbutWgZ8XOtHkSdRLAd6ZpQiar5icTC7Q9l9hU16Z3UlpaTZ1tS1bL82Q89w5GXsqKKicickyicGvw7a3vw/0",last_msg:"abc"}],[24,{count:20,patient_img:"http://wx.qlogo.cn/mmopen/5nv6lZBCcSFIiaFrgDn2iaKIZQlcnO4dU8F59fnSA1PT1EHpWcaLhWiaC5vqszcEVDBZKF8DDcYlut0KcjPelOSdhcqNEasTTrn/0",last_time:1442815514740,patient_name:"大贝",patient_id:24,last_msg:"abc"}]],[[24,{patient_remark:null,patient_name:"许小娟",patient_id:24,last_time:1450775403e3,count:0,patient_img:"http://wx.qlogo.cn/mmopen/S9AS0PYRpIwzjI4dt7LPbCIP8WfHjtapsny3HvrTc9gdtd2agvFTMZaUdMo55XQSpiafibDoUUt5Zp8qVBIia25dBfyy29AXFc9/0",last_msg:"abc"}]],{totalCount:10,totalPage:3,pageNo:1}],code:0,msg:"success"},latestMessage={ajax:null,messageBox:null,requestUrl:SYS_VAR.SERVER_ADDRESS,pageInfo:{page:1,num:10},pageObj:null,init:function(a){a&&(this.pageObj=a.pageObj,this.ajax=a.pageObj.ajaxForMessage,this.messageBox=a.pageObj.messageBox,this.skipPage=a.pageObj.skipPage)},getLatestMessage:function(){var a,b={sendParameters:{}};a=document.querySelector("#patient-latest-list"),b.sendParameters.doctor_id=this.pageObj.doctorId,b.sendParameters.page=this.pageInfo.page,b.sendParameters.num=this.pageInfo.num,b.url=this.requestUrl+"chat_api/get_consult",b.type="GET",b.asyn=!0,b.onSuccess=this.getLatestMessageSuccess.bind(this),b.onError=patientAdmin.handleGetError.bind(patientAdmin),this.pageObj.showLoading(),this.skipPage.init({pageInfo:this.pageInfo,bindObj:a,param:b,ajax:this.ajax,needSkipNext:!0,needSkipPrev:!1,messageBox:this.messageBox,scrollObj:a,isSelfInterface:!0})},getLatestMessageSuccess:function(a){var b,c,d=document.querySelector("#patient-latest-list"),e=[],f='<p class="no-data-tip no-data-latest-msg"></p>';0===a.code?(this.pageObj.hideLoading(),this.skipPage.isFirstLoad=!1,a.data&&a.data.length>0?(e=this.getNewLatestMessageData(a.data),b=e.length>0?this.getLatestMsgListHtml(e):1===this.pageInfo.page?f:""):b=1===this.pageInfo.page?f:"",b!==f?(c=document.createElement("ul"),c.className="cm-list cm-list-border-top cm-list-t-img-ctrl",c.innerHTML=b,d.appendChild(c)):1===this.pageInfo.page&&(d.innerHTML=b)):this.pageObj.handleGetError(a)},getNewLatestMessageData:function(a){var b=[];return a[0]&&a[0].length>0&&(a[0].map(function(a){a[1].isTop=!0}),b=b.concat(a[0])),a[1]&&a[1].length>0&&(b=b.concat(a[1])),b},getLatestMsgListHtml:function(a){for(var b,c,d,e,f,g=0;g<a.length;g++){var h="../chat/chat.html",i="";c=a[g][1].patient_remark||a[g][1].patient_name,d=a[g][1].patient_img,f=timeFormat.getTimeText(a[g][1].last_time),d=this.pageObj.getPatientDefaultIcon(a[g][1].patient_img),a[g][1].patient_img=d,h+="?doctor_id="+encodeURIComponent(this.pageObj.doctorId),h+="&patient_id="+encodeURIComponent(a[g][0]),h+="&patient_name="+encodeURIComponent(c),h+="&patient_icon="+encodeURIComponent(d),e="'"+encodeURIComponent(a[g][0])+"'",e+=",'"+encodeURIComponent(c)+"'",e+=",'"+encodeURIComponent(d)+"'",e+=",'"+encodeURIComponent(this.pageObj.doctorId)+"'",a[g][1].count>0&&(i=a[g][1].count,i=i>99?"99+":i),a[g][1].isTop===!0?a[g].topClass="top-message":a[g].topClass="",a[g][1].chatUrl=h,a[g][1].countNo=i,a[g][1].last_time=f,a[g][1].doctorId=this.pageObj.doctorId}return b=template(document.getElementById("qna-list-tpl").innerHTML,{list:a})},getFormatTime:function(a){},handleLatestMessage:function(){this.pageObj.hasLoadedLatestMessage===!1&&(this.pageObj.hasLoadedLatestMessage=!0,this.getLatestMessage())}},mockMyPatientList={code:0,msg:"成功",data:[{key:"#",voList:[{id:1,patientIcon:"",name:"士大夫似的1",gender:"男",age:31,createTime:1433312904e3}]},{key:"A",voList:[{id:1,patientIcon:"http://file-www.sioe.cn/201109/14/222211817.jpg",name:"士大夫似的1",gender:"男",age:31,createTime:1433312904e3}]},{key:"B",voList:[{id:1,patientIcon:"http://file-www.sioe.cn/201109/14/222211817.jpg",name:"士大夫似的1",gender:"男",age:31,createTime:1433312904e3}]},{key:"D",voList:[{id:1,patientIcon:"http://file-www.sioe.cn/201109/14/222211817.jpg",name:"士大夫似的1",gender:"男",age:31,createTime:1433312904e3}]},{key:"F",voList:[{id:1,patientIcon:"http://file-www.sioe.cn/201109/14/222211817.jpg",name:"士大夫似的1",gender:"男",age:31,createTime:1433312904e3}]},{key:"G",voList:[{id:1,patientIcon:"http://file-www.sioe.cn/201109/14/222211817.jpg",name:"士大夫似的1",gender:"男",age:31,createTime:1433312904e3}]},{key:"W",voList:[{id:1,patientIcon:"http://file-www.sioe.cn/201109/14/222211817.jpg",name:"士大夫似的1",gender:"男",age:31,createTime:1433312904e3}]}]},patientList={ajax:null,messageBox:null,requestUrl:SYS_VAR.SERVER_ADDRESS,pageObj:null,abcKeyList:["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","#"],init:function(a){a&&(this.pageObj=a.pageObj,this.ajax=a.pageObj.ajaxForPatient,this.messageBox=a.pageObj.messageBox)},getMyPatientList:function(){var a={sendParameters:{}},b="doc/get_group_list/",c=this.getMyPatientListSuccess;this.pageObj.doRequest(b,a,c,patientList,this.ajax)},getMyPatientListSuccess:function(a){var b=[],c=document.querySelector("#patient-list");if(0===a.code){if(a.data&&a.data.length>0){a.data;b=b.concat(this.getABCHtmlList(a.data))}else b.push('<p class="no-data-tip no-data-patient"></p>');c.innerHTML=b.join(""),abcSideBar.showABCSideBar({list:this.abcKeyList,bindObj:document.querySelector("#listContent")}),this.pageObj.hideLoading()}else this.pageObj.handleGetError(a)},getABCHtmlList:function(a){var b=[],c=this;return a.forEach(function(a){var d,e=a.voList,f=a.key;d="#"===f?"other":a.key,b.push('<a name="key_'+d+'" class="navigate-key" id="ABC_key_'+d+'">'+f+"</a>"),b.push("<span>"),b.push(c.getPatientListHtml(e)),b.push("</span>")}),b},getPatientListHtml:function(a){for(var b,c,d=0;d<a.length;d++){var e="../patient-info/patient-info.html",f=1==a[d].gender?"男":"女",g=a[d].age;c=this.pageObj.getPatientDefaultIcon(a[d].patientIcon),a[d].patientIcon=c,e+="?patient_id="+encodeURIComponent(a[d].id),e+="&patient_name="+encodeURIComponent(a[d].remarkName||a[d].name),e+="&patient_icon="+encodeURIComponent(a[d].patientIcon),e+="&doctor_id="+encodeURIComponent(this.pageObj.doctorId),g&&""!==g&&"null"!==g&&"undefined"!==g?g+="岁":g="",a[d].chatUrl=e,a[d].genderStr=f,a[d].ageStr=g}return b=template(document.getElementById("patient-list-tpl").innerHTML,{list:a})},handlePatientList:function(){var a,b;this.pageObj.hasLoadedPatientList===!1?(this.pageObj.hasLoadedPatientList=!0,this.getMyPatientList()):(a=document.querySelector("#abcSideBarOuter"),b=a?a.style:null,b&&a.style.display&&"none"===a.style.display&&searchPatient.showOrHidePatientList(!0))},getLatestPatient:function(){var a={sendParameters:{patientIds:""}},b="doc/patient_new_list/",c=this.setLatestHref;this.pageObj.doRequest(b,a,c,patientList)},setLatestHref:function(a){var b=document.querySelector("#latestPatient"),c="patient-list-latest.html";"0"===a.code||0===a.code?(a.data&&a.data.length>0&&(c=c+"?doctorId="+this.pageObj.doctorId,b.setAttribute("href",c)),this.pageObj.hideLoading()):this.pageObj.handleGetError(a)}},mockSearchPatientList={code:0,msg:"成功",data:[{id:1,patientIcon:"http://file-www.sioe.cn/201109/14/222211817.jpg",name:"我叫被搜索1",gender:1,age:123,createTime:1434680904e3}]},searchPatient={ajax:null,messageBox:null,searchFromDatabase:null,requestUrl:SYS_VAR.SERVER_ADDRESS,pageObj:null,init:function(a){a&&(this.pageObj=a.pageObj,this.ajax=a.pageObj.ajaxForPatient,this.messageBox=a.pageObj.messageBox,this.searchFromDatabase=new SearchFromDatabase,this.searchFromDatabase.init({callback:searchPatient.doSearch.bind(this),messageBox:searchPatient.messageBox,pageObj:searchPatient,pageObjString:"searchPatient",searchObjString:"searchFromDatabase",bindObj:document.querySelector("#searchBinObj"),tipText:"搜索",onchangeCallback:searchPatient.handleInputChange.bind(searchPatient)}),this.attacheEvent())},doSearch:function(a){if(a=a||this.searchFromDatabase.key){var b={sendParameters:{key:a}},c="doc/search_patient/",d=this.doSearchSuccess;this.clearSearchList(),this.pageObj.doRequest(c,b,d,searchPatient,this.ajax),this.showOrHidePatientList(!1)}},doSearchSuccess:function(a){var b=[],c=document.querySelector("#patient-search-list");0===a.code?a.data&&a.data.length>0?(b.push("<span>"),b=b.concat(patientList.getPatientListHtml(a.data)),b.push("</span>"),c.innerHTML=b.join(""),this.showOrHidePatientList(!1),this.pageObj.hideLoading()):this.pageObj.handleGetError({msg:"没有找到您要搜索的患者"}):this.pageObj.handleGetError(a)},showOrHidePatientList:function(a){var b=document.querySelector("#patient-list"),c=document.querySelector("#patient-search-list"),d=document.querySelectorAll("#searchBinObj input")[0];b.style.display=a?"block":"none",c.style.display=a?"none":"block",d.value=a?"":d.value},handleInputChange:function(a){var b=a.currentTarget.querySelectorAll("input")[0].value;b&&""!==b||this.showOrHidePatientList(!0)},clearSearchList:function(){document.querySelector("#patient-search-list").innerHTML=""},attacheEvent:function(){var a=document.querySelector("#searchBinObj"),b=document.querySelectorAll("#searchBinObj input")[0];a.addEventListener("keyup",function(){this.handleInputChange(event)}.bind(this)),b.addEventListener("focus",function(){document.querySelector("#abcSideBarOuter").style.display="none"}),b.addEventListener("blur",function(){""===this.value&&(document.querySelector("#abcSideBarOuter").style.display="block")})}},timeFormat={pageObj:null,init:function(a){a&&(this.pageObj=a.pageObj),this.formatTime=new FormatTime},getTimeText:function(a){var b,c=new Date,d=this.formatTime.getString(a).time,e=this.formatTime.getString(c.getTime()).time,f=6e4,g=60*f,h=24*g,i=720*g,j=c.getTime()-a,k=e.year-d.year,l=d.month+"月"+d.day+"日"+d.hour+":"+d.minute;return b=f>=j?"刚刚":j>f&&g>=j?Math.floor(j/1e3/60)+"分钟前":j>g&&h>=j?Math.floor(j/1e3/60/60)+"小时前":j>h&&i>=j?Math.floor(j/1e3/60/60/24)+"天前":0===k?Math.abs(e.month-d.month)+"月前":k>1?k+"年前":d.year+"年"+l}},patientAdmin={server:SYS_VAR.SERVER_ADDRESS,messageBox:null,ajax:null,popWindow:null,slideTab:null,requestUrl:SYS_VAR.SERVER_ADDRESS,hasLoadedLatestMessage:!1,hasLoadedPatientList:!1,init:function(){this.messageBox=new MessageBox,this.ajaxForMessage=new Ajax,this.ajaxForPatient=new Ajax,this.popWindow=new PopWindow,this.slideTab=new SlideTabs,this.skipPage=new SkipPage,this.slideTab.init({trigger:document.querySelector("#tabControl"),responser:document.querySelectorAll(".tab-con"),selectedCss:"selected"}),this.doctorId=getQueryString("doctorId"),timeFormat.init({pageObj:patientAdmin}),abcSideBar.init({pageObj:patientAdmin}),latestMessage.init({pageObj:patientAdmin}),patientList.init({pageObj:patientAdmin}),searchPatient.init({pageObj:patientAdmin}),this.hasLoadedLatestMessage=!0,latestMessage.getLatestMessage(),this.attachEvent()},doRequest:function(a,b,c,d,e){var f=b;f.url=this.requestUrl+a,f.type="GET",f.asyn=!0,f.onSuccess=c.bind(d||this),f.onError=this.handleGetError.bind(this),this.showLoading(),e.send(f)},handleGetError:function(a){var b=a.msg;this.hideLoading(),b&&""!==b||(b="系统异常，请稍后重试。"),this.messageBox.show({msg:b,type:"alert",autoClose:!0})},showPatientInfo:function(a){var b="../patient-info/patient-info.html",c=a.currentTarget,d=encodeURIComponent(c.getAttribute("data-patient-id")),e=encodeURIComponent(c.getAttribute("data-patient-name")),f=encodeURIComponent(c.getAttribute("data-patient-img")),g=encodeURIComponent(c.getAttribute("data-doctor-id")),h="?patient_id="+d+"&patient_name="+e+"&doctor_id="+g+"&patient_icon="+f;window.location.href=b+h},getPatientDefaultIcon:function(a){var b="patient_header.png",c=SYS_VAR.STATIC_ADDRESS+"styles/images/patient_default.png";return a&&""!==a&&"null"!==a&&"undefined"!==a?a.indexOf(b)>=0&&(a=c):a=c,a},showPatientChatMessage:function(a){var b=a.currentTarget.getAttribute("data-url");window.location.href=b},showLoading:function(){this.messageBox.show({msg:'<span class="fa fa-spinner fa-pulse fa-2x fa-fw"></span>',type:"loading",autoClose:!1})},hideLoading:function(){this.messageBox.hide()},attachEvent:function(){var a=document.querySelector("#patient-qna-list"),b=document.querySelector("#my-patient");a.addEventListener("click",function(){latestMessage.handleLatestMessage()}.bind(this)),b.addEventListener("click",function(){patientList.handlePatientList()}.bind(this))}};patientAdmin.init();