"use strict";var mockAuthData={code:0,msg:"",data:[{authStatus:1}]},chatCheckUserAuth={messageBox:null,ajax:null,popWindow:null,pageObj:null,callbackFunctions:{},init:function(a){a&&(this.ajax=a.pageObj.ajax,this.messageBox=a.pageObj.messageBox,this.popWindow=a.pageObj.popWindow,this.pageObj=a.pageObj)},getCheckData:function(a){var b={sendParameters:{}};this.callbackFunctions.successCallback=a.successCallback,this.callbackFunctions.errorCallback=a.errorCallback,b.url=this.pageObj.requestUrl+"doc/user_auth_data/",b.type="GET",b.asyn=!0,b.onSuccess=this.handleGetAuthDataSuccess.bind(this),b.onError=this.handleGetAuthData.bind(this),this.ajax.send(b)},handleGetAuthDataSuccess:function(a){0===a.code||"0"===a.code?this.getUseAuthInfo(a.data[0]):this.handleGetAuthData()},handleGetAuthData:function(){this.pageObj.authStatus=4,this.callbackFunctions.errorCallback&&this.callbackFunctions.errorCallback()},getUseAuthInfo:function(a){a&&(this.pageObj.authStatus=parseInt(a.authStatus,10),this.pageObj.authDorctorPhoto=a.photoUrl,this.pageObj.doctorInfo.headImg=a.photoUrl,this.pageObj.doctorInfo.id=a.doctorId,this.pageObj.doctorInfo.name=a.name),this.callbackFunctions.successCallback&&this.callbackFunctions.successCallback()},showNoVerifyTipMessage:function(a){var b,c="../my/my-information.html";1===a?b="由于没有通过身份认证，为减少用户的用药风险，您暂时无法使用推荐用药功能。如果您还没有进行过身份认证，建议提交资料进行身份认证。":2===a&&(b="您尚未通过身份认证审核。如果您还没有进行过身份认证，建议提交资料进行身份认证，以避免医疗咨询风险。"),(0===this.pageObj.authStatus||2===this.pageObj.authStatus||3===this.pageObj.authStatus)&&(c="../authorization/author-verification.html"),b=b+'<a class="re-send-msg"  onclick="chatCheckUserAuth.setPageStatus(\'chatStatus\', \'1\');" href="'+c+'">去认证！</a>',this.pageObj.sendSysErrorMessage(b)},setPageStatus:function(a,b){window.localStorage.setItem(a,b)}},chatControlPanel={messageBox:null,ajax:null,popWindow:null,pageObj:null,callbackFunctions:{},recordTimer:{triggerTimer:0,maxTimeLength:30,step:1,count:0,countTimer:0},init:function(a){a&&(this.ajax=a.pageObj.ajax,this.messageBox=a.pageObj.messageBox,this.popWindow=a.pageObj.popWindow,this.pageObj=a.pageObj),this.attachEvent()},handleControlPanelClick:function(a){var b=a.target,c=b.tagName.toLowerCase(),d=b.getAttribute("event");"a"===c&&"openExternal"===d?this.handleExtPanelToggle(a):"a"===c&&"sendMsg"===d?this.handleSendMsg(a):"a"===c&&"openAudio"===d?this.handleAudioPanelToggle(a,!0):"a"===c&&"closeAudio"===d?this.handleAudioPanelToggle(a,!1):"a"===c&&"recommendMedical"===d?chatRecommend.doRecommondMedical():"a"===c&&"markInformation"===d?chatMarkPatientInfo.doMarkPatientInfo():"a"===c&&"sendImage"===d?chatMessageImage.chooseImageFile():"a"===c&&"recommendPrescription"===d&&chatRecommend.skipPageToDoRecommend("templates/prescriptions/prescriptions-recommend.html")},handleAudioPanelTouchStart:function(a){this.clearStartTimer(),this.recordTimer.countTimer=setInterval(function(){this.recordTimer.count++,this.recordTimer.count>=this.recordTimer.maxTimeLength&&(this.clearStartTimer(),this.startRecord(a.currentTarget))}.bind(this),this.recordTimer.step),a.stopPropagation(),a.preventDefault()},handleAudioPanelTouchEnd:function(a){this.clearStartTimer(),chatMessageAudio.isDoingRecord===!0&&this.endRecord(a.currentTarget),a.stopPropagation(),a.preventDefault()},startRecord:function(a){chatMessageAudio.isDoingRecord===!1&&chatMessageAudio.startRecord(a)},endRecord:function(a){chatMessageAudio.endRecord(a)},handleSendMsg:function(a){var b=document.querySelector("#msgText"),c={target:b};this.pageObj.doSendTextMessage(a,b,function(){this.toggleTextMsgOpt(c)}.bind(this)),setTimeout(function(){this.afterSendMessageScroll()}.bind(this),50),a.stopPropagation()},handleExtPanelToggle:function(a){this.toggleExternalOpt(),a.stopPropagation()},handleAudioPanelToggle:function(a,b){this.toggleAudioOpt(b),a.stopPropagation()},toggleExternalOpt:function(a){var b;b=document.querySelector("#chatMain"),a!==!0&&a!==!1&&(a=b.className.indexOf("chat-show-external")>=0?!1:!0),b.className=a===!1?"chat-main":"chat-main chat-show-external"},toggleTextMsgOpt:function(a){var b=document.querySelectorAll('#chatControlPanel a[event="openExternal"]')[0],c=document.querySelector("#sendMsg"),d=!1;d=a.target.value&&""!==a.target.value?!0:!1,b.style.display=d===!0?"none":"block",c.style.display=d===!0?"block":"none"},toggleAudioOpt:function(a,b){var c,d,e,f;c=document.querySelector("#chatControlPanel"),e=c.querySelector("#msgText"),d=c.querySelector("#audioOptPanel"),f=document.querySelectorAll('#chatControlPanel a[event="openAudio"]')[0],d.style.display=a===!0?"block":"none",a===!1?(e.style.display="inline",f.style.display="inline",b!==!0&&e.focus()):(e.style.display="none",f.style.display="none"),a===!0&&this.toggleExternalOpt(!1)},toggleRecordPanel:function(a){a||(a=document.querySelector("#audioRecordButton")),a.className=chatMessageAudio.isDoingRecord===!0?"selected":"",a.innerHTML=chatMessageAudio.isDoingRecord===!0?"松开 结束":"按住 说话"},afterSendMessageScroll:function(){this.pageObj.scrollToMsg()},clearStartTimer:function(){clearTimeout(this.recordTimer.triggerTimer),clearTimeout(this.recordTimer.countTimer),this.recordTimer.count=0},writeLog:function(a){var b,c;document.querySelector("#logPanel")?b=document.querySelector("#logPanel"):(b=document.createElement("div"),b.setAttribute("id","logPanel"),b.setAttribute("style","background: #fff; position: fixed; top:0;  bottom: 150px; overflow:auto; left:0; right:0; opacity:0.8; z-index: 30; font-size: 12px; line-height: 18px;"),document.querySelectorAll("body")[0].appendChild(b)),c=document.createElement("span"),c.innerHTML="<p>"+a+"</p>",b.appendChild(c)},attachEvent:function(){var a=document.querySelector("#chatControlPanel"),b=document.querySelector("#audioRecordButton"),c=document.querySelector("#msgText");a.addEventListener("touchstart",function(a){this.handleControlPanelClick(a)}.bind(this)),b.addEventListener("touchstart",function(a){this.handleAudioPanelTouchStart(a)}.bind(this)),b.addEventListener("touchend",function(a){this.handleAudioPanelTouchEnd(a)}.bind(this)),c.addEventListener("input",function(a){this.toggleTextMsgOpt(a)}.bind(this)),c.addEventListener("focus",function(a){this.toggleTextMsgOpt(a)}.bind(this))}},chatInitWXAPI={pageObj:null,messageBox:null,ajax:null,popWindow:null,wxSDK:null,isAPILoadSuccess:!1,init:function(a){this.wxSDK=new WeixinSDK,a&&(this.ajax=new Ajax,this.messageBox=a.pageObj.messageBox,this.popWindow=a.pageObj.popWindow,this.pageObj=a.pageObj)},doInitWXAPI:function(){var a;a={debug:null,successCallback:this.wxAPIInitSuccess.bind(this),errorCallback:this.wxAPIInitFail.bind(this),jsApiList:["startRecord","stopRecord","onVoiceRecordEnd","playVoice","pauseVoice","stopVoice","onVoicePlayEnd","uploadVoice","downloadVoice","chooseImage","previewImage","uploadImage","downloadImage"],ajax:this.ajax},this.wxSDK.init(a)},wxAPIInitSuccess:function(){this.isAPILoadSuccess=!0,chatMessageAudio.isAPILoadSuccessCallback()},wxAPIInitFail:function(){this.isAPILoadSuccess=!1}},chatMarkPatientInfo={pageObj:null,messageBox:null,ajax:null,popWindow:null,init:function(a){a&&(this.ajax=a.pageObj.ajax,this.messageBox=a.pageObj.messageBox,this.popWindow=a.pageObj.popWindow,this.pageObj=a.pageObj)},doMarkPatientInfo:function(){var a=[],b={buttons:[],space:{}};b.needMask=!0,b.space={height:310,left:10},a.push('<div class="mark-info-box">'),a.push('<h1>病情备注<a class="close-pop" onclick="chatMarkPatientInfo.cancelSaveMarkInfo();"></a></h1>'),a.push('<div class="patient-mark">'),a.push('<div class="box"><textarea id="patientMarkInfo" placeholder="最多100个字" maxlength="100"></textarea></div>'),a.push("</div>"),a.push('<a class="do-save-btn" onclick="chatMarkPatientInfo.doSaveMarkInfo();">确定</a>'),a.push("</div>"),b.content=a.join(""),this.popWindow.show(b)},doSaveMarkInfo:function(){var a,b=document.querySelector("#patientMarkInfo").value;if(a=this.doValidateInfo(b),a.result!==!0)return this.messageBox.show({msg:a.msg,type:"alert",autoClose:!0}),!1;var c={sendParameters:{}};c.sendParameters.patientId=this.pageObj.urlParams.patient_id,c.sendParameters.doctorId=this.pageObj.urlParams.doctor_id,c.sendParameters.content=encodeURIComponent(b),c.url=this.pageObj.requestUrl+"doc/add_record/",c.type="GET",c.asyn=!0,c.onSuccess=this.onSaveMarkInfoSuccess.bind(this),c.onError=this.onSaveMarkInfoError.bind(this),this.isSavingMsgData=!0,this.pageObj.showLoading(),this.ajax.send(c)},doValidateInfo:function(a){return a&&""!==a?a.isNormalTextArea(2,100)?{msg:"",result:!0}:{msg:"请将备注信息控制在100字之内",result:!1}:{msg:"请输入正确的备注信息",result:!1}},cancelSaveMarkInfo:function(){this.popWindow.hide()},onSaveMarkInfoSuccess:function(a){0===a.code||"0"===a.code?(this.pageObj.hideLoading(),this.onSaveMarkInfoError({msg:"备注信息添加成功"})):this.onSaveMarkInfoError(a),this.isSavingMsgData=!1},onSaveMarkInfoError:function(a){var b=a.msg;b&&""!==b||(b="网络异常请稍后再试。"),this.messageBox.show({msg:b,type:"alert",autoClose:!0}),this.isSavingMsgData=!1,this.cancelSaveMarkInfo()}},chatMessageAudio={pageObj:null,messageBox:null,ajax:null,popWindow:null,audioInfo:{timeLength:100,timer:0,step:100,localId:null,serverId:null},userPressButtonShortTime:0,isDoingRecord:!1,playInfo:{isPlayingPanel:null,isPlaying:!1,playingAudio:null,isEnding:!1,timer:0,step:1},hasTriggered:!1,init:function(a){a&&(this.ajax=a.pageObj.ajax,this.messageBox=a.pageObj.messageBox,this.popWindow=a.pageObj.popWindow,this.pageObj=a.pageObj)},isAudioApiOk:function(){return chatInitWXAPI.isAPILoadSuccess!==!0?(this.messageBox.show({msg:"微信音频API初如化失败，请刷新页面重试",type:"alert",autoClose:!0}),!1):!0},isAPILoadSuccessCallback:function(){var a=this;wx.onVoiceRecordEnd({complete:function(b){this.isDoingRecord=!1,a.recordOverTime(b)}}),wx.onVoicePlayEnd({success:function(b){a.stopAudio(2,b.localId)}})},triggerAudioFunction:function(){this.hasTriggered===!1&&(this.hasTriggered=!0)},startRecord:function(a){var b=this;return this.isAudioApiOk()===!1?!1:void wx.startRecord({success:function(b){"startRecord:ok"===b.errMsg&&this.startSuccess(b,a)}.bind(b)})},startSuccess:function(a,b){var c=this.audioInfo;this.isDoingRecord=!0,c.localId=null,c.serverId=null,chatControlPanel.toggleRecordPanel(b),c.timeLength=0,clearInterval(c.timer),c.timer=setInterval(function(){c.timeLength+=c.step}.bind(this),c.step)},endRecord:function(a){var b=this,c=this.audioInfo;return this.isAudioApiOk()===!1?!1:(clearInterval(c.timer),this.isDoingRecord=!1,chatControlPanel.toggleRecordPanel(a),void wx.stopRecord({success:function(a){"stopRecord:ok"===a.errMsg&&this.endRecordSuccess(a)}.bind(b)}))},endRecordSuccess:function(a){var b=this,c=this.audioInfo;c.timeLength>59999&&(c.timeLength=59999),c.localId=a.localId,b.completeRecord(a)},recordOverTime:function(a){var b=this.audioInfo;clearInterval(b.timer),this.isDoingRecord=!1,chatControlPanel.toggleRecordPanel(document.querySelectorAll("#audioOptPanel div")[0]),this.endRecordSuccess(a)},completeRecord:function(){var a=this.audioInfo,b=this;wx.uploadVoice({localId:a.localId,success:function(c){a.serverId=c.serverId,b.uploadVoiceSuccessCallback()}})},uploadVoiceSuccessCallback:function(){this.doSendAudioMessage(),this.pageObj.hideLoading()},doSendAudioMessage:function(){var a=this.audioInfo;this.pageObj.combineSendMsgParams("",4,a.serverId,a.localId,a.timeLength)},getCellHtml:function(a,b){var c,d,e=[],f="audio-msg fa",g=' media_id="'+(a.content.media_id||"")+'"',h=' local_id="'+(a.content.local_id||"")+'"',i=a.content.timeLength||0;return f+=1===a.relation?" from-doctor stop-play":" from-patient stop-play",i>100&&(i=Math.ceil(parseInt(i,10)/1e3)),i=i>59?59:i,d=(document.documentElement.clientWidth-130)*(i/59),c=a.media_id&&""!==a.media_id&&"null"!==a.media_id&&"undefined"!==a.media_id?"":'<audio controls="controls" src="'+(b+a.content.path)+'" type="audio/mpeg"></audio>',e.push("<span "+g+h+' class="audio-outer" onclick="chatMessageAudio.playOrPauseAudio(event);" style="width:'+(d||20)+'px;">'),e.push('<span class="'+f+'"><p class="mask"></p></span>'),e.push('<div class="fix-bug-iso4">'),e.push(c),e.push("</div>"),e.push("</span>"),e.push('<b class="time-length">'+i+"''</b>"),e.join("")},playOrPauseAudio:function(a){var b=a.currentTarget,c=b.querySelectorAll("audio")[0],d=b.getAttribute("local_id");this.stopAllAudiosPlayExceptCurrent(d,c,b)},playAudio:function(a,b,c){var d=this.playInfo,e=c.querySelectorAll("span")[0];a&&""!==a&&"null"!==a&&"undefined"!==a?this.playAudioFromWX(a):this.playAudioFromH5(b),d.isPlaying=!0,d.isPlayingPanel=c,e.className=e.className.replace(" stop-play"," start-play")},pauseAudio:function(a,b,c){var d=this.playInfo,e=c.querySelectorAll("span")[0];a&&""!==a&&"null"!==a&&"undefined"!==a?this.pauseAudioFromWX(a):d.playingAudio&&this.pauseAudioFromH5(b),d.isPlaying=!1,e.className=e.className.replace(" start-play"," stop-play")},playAudioFromWX:function(a){wx.playVoice({localId:a}),this.playInfo.playingAudio=null},pauseAudioFromWX:function(a){wx.pauseVoice({localId:a})},playAudioFromH5:function(a){var b=this.playInfo;b.playingAudio=a,a.play(),clearInterval(b.timer),b.timer=setInterval(function(){a.ended===!0&&this.stopAudio(1,a)}.bind(this),b.step)},pauseAudioFromH5:function(a){var b=this.playInfo;b.playingAudio=a,a.pause(),clearInterval(b.timer)},stopAudio:function(a,b){var c=this.playInfo,d=c.isPlayingPanel,e=d.querySelectorAll("span")[0];1===a?clearInterval(c.timer):wx.stopVoice({localId:b}),e.className=e.className.replace(" start-play"," stop-play"),c.isPlaying=!1,c.isPlayingPanel=null,c.playingAudio=null,c.isEnding=!1},stopAllAudiosPlayExceptCurrent:function(a,b,c){if(this.playInfo.isPlaying===!1)this.playAudio(a,b,c);else if(c===this.playInfo.isPlayingPanel)this.pauseAudio(a,b,c);else{var d=this.playInfo.isPlayingPanel.getAttribute("local_id"),e=this.playInfo.isPlayingPanel.querySelectorAll("audio")[0];d&&""!==d?this.stopAudio(2,d):this.stopAudio(1,e),this.playAudio(a,b,c)}}},mockdata_history={code:0,msg:"成功",data:[{pageNo:1,orderBy:"desc",pageSize:10,baseUrl:"http://10.9.2.34",totalPage:4,totalCount:34,result:[{sendTime:1449656249711,content:{size:0,path:"/ci/7019/43397/20151209/1449656248112.jpg",timeLength:188822},relation:1,to:{headImg:"http://wx.qlogo.cn/mmopen/PiajxSqBRaEI0HsReaC5orfMRUltNgmETjWpIGq2dYV83xjQWBtpA1Weh8YbA2TcsV8goFPtVyteQarHdcSRuuhqRsEeSd6Xnk93yhaxX9OA/0",id:43397,name:"龙葵测试"},msgFormat:1,type:2,id:"5667ffb9e4b02f6cfef067d7",from:{headImg:"http://10.9.2.10:8090/dri/photo/7019/1446726793940.jpg",id:7019,name:"邱测试哦明夫妇啊爱你"}},{sendTime:1449656256860,content:{size:0,path:"http://doctormx.dev.7lk.com/trans_recording/cr_7019_43397_20151209_1449656256094.mp3",timeLength:60},relation:0,to:{headImg:"http://wx.qlogo.cn/mmopen/PiajxSqBRaEI0HsReaC5orfMRUltNgmETjWpIGq2dYV83xjQWBtpA1Weh8YbA2TcsV8goFPtVyteQarHdcSRuuhqRsEeSd6Xnk93yhaxX9OA/0",id:43397,name:"龙葵测试"},msgFormat:1,type:4,id:"5667ffc0e4b02f6cfef067d9",from:{headImg:"http://10.9.2.10:8090/dri/photo/7019/1446726793940.jpg",id:7019,name:"邱测试哦明夫妇啊爱你"}},{sendTime:1449656256860,content:{size:0,path:"http://doctormx.dev.7lk.com/trans_recording/cr_7019_43397_20151209_1449656256094.mp3",timeLength:80},relation:1,to:{headImg:"http://wx.qlogo.cn/mmopen/PiajxSqBRaEI0HsReaC5orfMRUltNgmETjWpIGq2dYV83xjQWBtpA1Weh8YbA2TcsV8goFPtVyteQarHdcSRuuhqRsEeSd6Xnk93yhaxX9OA/0",id:43397,name:"龙葵测试"},msgFormat:1,type:4,id:"5667ffc0e4b02f6cfef067d9",from:{headImg:"http://10.9.2.10:8090/dri/photo/7019/1446726793940.jpg",id:7019,name:"邱测试哦明夫妇啊爱你"}},{sendTime:1452006798350,content:"http://wx.qlogo.cn/mmopen/PiajxSqBRaEI0HsReaC5orfMRUltNgmETjWpIGq2dYV83xjQWBtpA1Weh8YbA2TcsV8goFPtVyteQarHdcSRuuhqRsEeSd6Xnk93yhaxX9OA/0",relation:1,to:{headImg:"http://wx.qlogo.cn/mmopen/PiajxSqBRaEI0HsReaC5orfMRUltNgmETjWpIGq2dYV83xjQWBtpA1Weh8YbA2TcsV8goFPtVyteQarHdcSRuuhqRsEeSd6Xnk93yhaxX9OA/0",id:43397,name:"龙葵测试"},msgFormat:1,type:1,id:"5667ffc0e4b02f6cfef067d9",from:{headImg:"http://10.9.2.10:8090/dri/photo/7019/1446726793940.jpg",id:7019,name:"邱测试哦明夫妇啊爱你"}}],authData:{authStatus:1,photoUrl:"../../styles/images/dor_header.png",doctorId:1002,name:"张三"}}]},chatMessageHistory={pageObj:null,messageBox:null,ajax:null,popWindow:null,skipPage:null,fullScreenViewer:null,init:function(a){a&&(this.ajax=a.pageObj.ajax,this.messageBox=a.pageObj.messageBox,this.popWindow=a.pageObj.popWindow,this.skipPage=a.pageObj.skipPage,this.fullScreenView=a.pageObj.fullScreenView,this.pageObj=a.pageObj)},getHistoryMessage:function(a){var b={sendParameters:{}},c=this.pageObj.urlParams,d=this.pageObj.historyPageInfo,e=this.pageObj.chatConfig;b.sendParameters.patient_id=c.patient_id,b.sendParameters.doctor_id=c.doctor_id,b.sendParameters.page=d.pageNo,b.sendParameters.num=d.pageSize,b.sendParameters.orderby=d.orderby,b.sendParameters.needAuthData=this.skipPage.isFirstLoad,b.url=e.chatGetHistoryServer+"chat_api/first_connect/",b.type="GET",b.asyn=!0,b.onSuccess=this.onGetHistorySuccess.bind(this),b.onError=this.onGetHistoryError.bind(this),this.skipPage.init({pageInfo:d,bindObj:a.bindObj,param:b,ajax:this.ajax,needSkipNext:!1,needSkipPrev:!0,messageBox:this.messageBox,scrollObj:a.bindObj})},onGetHistorySuccess:function(a){0===a.code||"0"===a.code?(this.pageObj.hideLoading(),this.skipPage.isFirstLoad===!0&&(this.getPatientandDoctorInfo(a.data[0]),chatCheckUserAuth.getUseAuthInfo(a.data[0].authData)),this.showHistoryMessage(a.data[0]),this.skipPage.isFirstLoad===!0&&(chatMessageAudio.triggerAudioFunction(),chatRecommend.getRecommondMessage(),chatPatientMessage.startGetPatientMessageTimer())):this.onGetHistoryError(a)},onGetHistoryError:function(a){this.messageBox.show({msg:a.msg||"获取聊天记录失败",type:"alert",autoClose:!0})},getPatientandDoctorInfo:function(a){var b=SYS_VAR.STATIC_ADDRESS+"styles/images/dor_header.png",c=SYS_VAR.STATIC_ADDRESS+"styles/images/patient_header.png",d=a.result,e=this.pageObj.patientInfo,f=this.pageObj.doctorInfo,g=this.pageObj.authDorctorPhoto,h=this.pageObj.urlParams;d&&d.length>0?("0"===d[0].relation||0===d[0].relation?(e=d[0].from,f=d[0].to):(e=d[0].to,f=d[0].from),this.pageObj.baseUrl=a.baseUrl,e.headImg&&""!==e.headImg&&"null"!==e.headImg&&"undefined"!==e.headImg?e.headImg.indexOf("http:/")<0&&(e.headImg=a.baseUrl+"/"+e.headImg):e.headImg=c,f.headImg&&""!==f.headImg&&"null"!==f.headImg&&"undefined"!==f.headImg?f.headImg.indexOf("http:/")<0&&(f.headImg=a.baseUrl+"/"+f.headImg):g&&""!==g&&"null"!==g&&"undefined"!==g?f.headImg=g:f.headImg=b):(e.headImg=h.patient_icon?decodeURIComponent(h.patient_icon):c,e.name=h.patient_name?h.patient_name:"患者",e.id=h.patient_id),this.pageObj.patientInfo=e,this.pageObj.doctorInfo=f},showHistoryMessage:function(a){for(var b="",c=a.result,d=a.pageNo||1,e=0;e<c.length;e++)b+=this.pageObj.getCellMessageHtml(c[e],a.baseUrl);this.pageObj.addMessageToPanel(b,!0,d,1===d)}},chatMessageImage={pageObj:null,messageBox:null,ajax:null,popWindow:null,imageInfo:{},init:function(a){a&&(this.ajax=a.pageObj.ajax,this.messageBox=a.pageObj.messageBox,this.popWindow=a.pageObj.popWindow,this.pageObj=a.pageObj),this.preloadImage()},preloadImage:function(){var a=new Image;a.setAttribute("src","../../styles/images/loading.gif")},chooseImageFile:function(){var a=this.imageInfo;return a.localId=null,a.serverId=null,this.isImageApiOk()===!1?!1:void wx.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:function(b){a.localId=b.localIds[0],chatMessageImage.uploadImageToWXServer(a.localId)}})},uploadImageToWXServer:function(a){var b=this.imageInfo;wx.uploadImage({localId:a,isShowProgressTips:1,success:function(a){b.serverId=a.serverId,chatMessageImage.uploadImageSuccessCallback()}})},uploadImageSuccessCallback:function(){var a=this.imageInfo;this.pageObj.combineSendMsgParams("",2,a.serverId,a.localId,0)},getCellHtml:function(a,b){var c=[],d=a.content.local_id;return c.push('<div class="image-msg">'),d&&""!==d&&"null"!==d&&"undefined"!==d?c.push('<img src="'+d+'" height="160" onclick="chat.mediaFullScreenView(\''+d+'\', 1, event);" onload="chat.scrollToMsg();" />'):c.push(a.content.path&&""!==a.content.path?'<img src="'+(b+a.content.path)+'?s=t" height="160" onclick="chat.mediaFullScreenView(\''+(b+a.content.path)+'\', 1, event);" onload="chat.scrollToMsg();" />':""),c.push("</div>"),c.join("")},isImageApiOk:function(){return chatInitWXAPI.isAPILoadSuccess!==!0?(this.messageBox.show({msg:"微信图片API初如化失败，请刷新页面重试",type:"alert",autoClose:!0}),!1):!0}},mockPatientData={code:0,msg:"success",data:[{result:[{sendTime:1302238374929,content:"么么哒",from:{headImg:"/user/ws.png",id:1015006,name:"王三"},to:{headImg:"/user/ls.png",id:1015006,name:"李四"},relation:0,type:1},{sendTime:1302238374929,content:"么么哒",from:{headImg:"/user/ws.png",id:1015006,name:"王三"},to:{headImg:"/user/ls.png",id:1015006,name:"李四"},relation:0,type:1}]}]},chatPatientMessage={messageBox:null,ajax:null,popWindow:null,pageObj:null,callbackFunctions:{},init:function(a){a&&(this.ajax=a.pageObj.ajax,this.messageBox=a.pageObj.messageBox,this.popWindow=a.pageObj.popWindow,this.pageObj=a.pageObj)},startGetPatientMessageTimer:function(){clearInterval(this.pageObj.getPatientMsgTimer),this.pageObj.getPatientMsgTimer=setInterval(function(){chatMessageHistory.skipPage.isGettingData===!1&&this.pageObj.isSavingMsgData===!1&&this.getPatientMessage()}.bind(this),this.pageObj.chatConfig.chatSaveMessageTimeStep)},getPatientMessage:function(){var a={sendParameters:{}},b=this.pageObj.urlParams,c=this.pageObj.chatConfig;a.sendParameters.patient_id=b.patient_id,a.sendParameters.doctor_id=b.doctor_id,a.url=c.chatGetHistoryServer+"chat_api/poll_connect/",a.type="GET",a.asyn=!0,a.onSuccess=this.onGetPatientMsgSuccess.bind(this),a.onError=this.onGetPatientMsgError.bind(this),this.ajax.send(a)},onGetPatientMsgSuccess:function(a){var b="",c=this,d=[];if(0===a.code||"0"===a.code)try{if(d=a.data[0].result,d&&d.length>0){for(var e=0;e<d.length;e++)b+=c.pageObj.getCellMessageHtml(d[e],this.pageObj.baseUrl);this.pageObj.addMessageToPanel(b,!0,null,!0)}}catch(f){alert(f)}},onGetPatientMsgError:function(a){}},chatRecommend={messageBox:null,ajax:null,popWindow:null,pageObj:null,callbackFunctions:{},init:function(a){a&&(this.ajax=a.pageObj.ajax,this.messageBox=a.pageObj.messageBox,this.popWindow=a.pageObj.popWindow,this.pageObj=a.pageObj)},getRecommondMessage:function(){var a,b=[],c={content:{}},d={};a=window.localStorage.getItem("recommondData"),a&&""!==a&&(a=decodeURIComponent(a),b=new Function("return "+a+";")(),c.from=this.pageObj.doctorInfo,c.to=this.pageObj.patientInfo,c.sendTime=(new Date).getTime(),c.content.recommandId="000000001",c.content.items=b,c.relation=1,c.type=16,window.localStorage.removeItem("recommondData"),d.message=c,this.pageObj.currentSendMessage=d,this.pageObj.doSaveMessage(d))},getRecommondHtml:function(a){var b,c=[],d=[],e=SYS_VAR.STATIC_ADDRESS+"templates/medical/medical-detail.html",f=0;if(a){c=a.content.items,d.push('<span class="recommond-list">'),d.push("<i>建议服用以下药物：</i>");for(var g=0;g<c.length;g++){if(f=0,d.push("<div>"),b=c[g].productName&&""!==c[g].productName?c[g].productName:"药品",c[g].commonName&&""!==c[g].commonName&&(b+="（"+c[g].commonName+"）"),d.push('<a href="'+e+"?medicalId="+c[g].productId+'">'),d.push(b),d.push("</a>"),c[g].quantity&&""!==c[g].quantity&&"0"!==c[g].quantity&&0!==c[g].quantity&&d.push(" x "+(c[g].quantity||0)),c[g].usage){var h=c[g].usage.split(",");h.forEach(function(a){d.push("<p>"+a+"</p>")})}else c[g].timePayDay&&""!==c[g].timePayDay&&"0"!==c[g].timePayDay&&0!==c[g].timePayDay&&(d.push("<p>1日"+c[g].timePayDay+"次</p>"),f++),c[g].timePayUnit&&""!==c[g].timePayUnit&&"0"!==c[g].timePayUnit&&0!==c[g].timePayUnit&&1===f&&(d.push("<p>1次"+c[g].timePayUnit+(c[g].unit||"")+"</p>"),f++);c[g].bakup&&""!==c[g].bakup&&d.push("<p>"+c[g].bakup+"</p>"),d.push('<p style="margin-top:8px; height:0; font-size:0; line-height:0;"></p>'),d.push("</div>")}d.push('<p class="text-right">以上药品由七乐康提供</p>'),d.push("</span>")}return d.join("")},doRecommondMedical:function(){this.skipPageToDoRecommend("templates/medical/medical-search.html")},skipPageToDoRecommend:function(a){var b,c=SYS_VAR.STATIC_ADDRESS+a,d=this.pageObj.urlParams;1!==this.pageObj.authStatus?chatCheckUserAuth.showNoVerifyTipMessage(1):(b="?type=recommond",b+="&patient_id="+d.patient_id,b+="&doctor_id="+d.doctor_id,b+="&patient_name="+d.patient_name,window.location.href=c+b)}},chatTimeFormat={pageObj:null,init:function(a){a&&(this.pageObj=a.pageObj),this.formatTime=new FormatTime},getTimeText:function(a){var b,c=new Date,d=this.formatTime.getString(a),e=this.formatTime.getString(c.getTime()),f=d.time,g=e.time,h=12e4,i=864e5,j=2*i,k=3*i,l=c.getTime()-a,m=g.year-f.year,n=f.month+1+"月"+f.day+"日"+f.hour+":"+f.minute;return b=h>=l?"":l>h&&i>=l?g.day-f.day===1?"昨天 "+f.hour+":"+f.minute:f.hour+":"+f.minute:l>i&&j>=l?g.day-f.day===2?"前天 "+f.hour+":"+f.minute:"昨天 "+f.hour+":"+f.minute:l>j&&k>=l?g.day-f.day>=3?n:"前天 "+f.hour+":"+f.minute:0===m?n:1===m?"去年 "+n:2===m?"前年 "+n:f.year+"年"+n}},chat={chatConfig:{chatHistoryCount:SYS_VAR.CHAT_HISTORY_COUNT,chatGetHistoryServer:SYS_VAR.CHAT_GET_HISTORY_SERVER,chatSaveDoctorMessageServer:SYS_VAR.CHAT_SAVE_DOCTOR_MESSAGE_SERVER,chatSaveMessageTimeStep:SYS_VAR.CHAT_GET_MESSAGE_TIME_STEP,chatGetPatientMessageServer:SYS_VAR.CHAT_GET_PATIENT_MESSAGE_SERVER,iconWidth:50},getPatientMsgTimer:0,urlParams:{patient_id:"",doctor_id:""},patientInfo:{id:0,name:"",headImg:""},doctorInfo:{id:0,name:"",headImg:""},historyPageInfo:{pageNo:1,orderby:1,pageSize:SYS_VAR.CHAT_HISTORY_COUNT},baseUrl:"",simpleLen:7,messageBox:null,ajax:null,popWindow:null,chatPanel:null,skipPage:null,fullScreenViewer:null,authStatus:4,authDorctorPhoto:null,isSavingMsgData:!1,requestUrl:SYS_VAR.SERVER_ADDRESS,currentSendMessage:{},init:function(){this.messageBox=new MessageBox,this.ajax=new Ajax,this.popWindow=new PopWindow,this.chatPanel=document.querySelectorAll(".chat-msg-list")[0],this.skipPage=new SkipPage,this.fullScreenView=new FullScreenView,this.getPatientId(),chatTimeFormat.init({pageObj:chat}),chatCheckUserAuth.init({pageObj:chat}),chatMessageHistory.init({pageObj:chat}),chatRecommend.init({pageObj:chat}),chatPatientMessage.init({pageObj:chat}),chatControlPanel.init({pageObj:chat}),chatMessageAudio.init({pageObj:chat}),chatMessageImage.init({pageObj:chat}),chatMarkPatientInfo.init({pageObj:chat}),chatInitWXAPI.init({pageObj:chat}),this.loadPage(),this.attachEvent()},loadPage:function(){this.showLoading(),chatMessageHistory.getHistoryMessage({bindObj:document.querySelector("#chatMsgList")}),chatInitWXAPI.doInitWXAPI()},getPatientId:function(){var a,b=window.location.search.replace("?",""),c=b.match(/(.[^?|&]+)=/g),d=b.match(/=(.[^&]*)/g),e=this;if(""===b)e.urlParams.patient_id=window.localStorage.getItem("patient_id"),e.urlParams.doctor_id=window.localStorage.getItem("doctor_id"),e.urlParams.patient_name=window.localStorage.getItem("patient_name");else{if(!c||!d)return!1;for(var f=0;f<c.length;f++){var g=c[f].replace(/=|\?|&/g,""),h=decodeURIComponent(d[f]).replace("=","");/^\d{1,}$/.test(h)&&(h=parseInt(h,10)),e.urlParams[g]=h}window.localStorage.setItem("patient_id",e.urlParams.patient_id),window.localStorage.setItem("doctor_id",e.urlParams.doctor_id),window.localStorage.setItem("patient_name",e.urlParams.patient_name)}a=e.urlParams.patient_name||"患者",document.querySelectorAll("title")[0].innerHTML=a+"　"},hackTitle:function(){},getCellMessageHtml:function(a,b){var c,d,e,f,g="",h="",i="";return d=this.getDateString(parseInt(a.sendTime,10)),a.content.path&&a.content.path.indexOf("http:/")>=0&&(b=""),0===a.relation||"0"===a.relation||(h="my-msg"),f=this.getPatientDefaultIcon(this.urlParams.patient_icon,"my-msg"===h?a.to:a.from),e="../../templates/patient-info/patient-info.html",e+="?patient_id="+encodeURIComponent(this.patientInfo.id),e+="&patient_name="+encodeURIComponent(this.urlParams.patient_name),e+="&patient_icon="+encodeURIComponent(f),e+="&doctor_id="+encodeURIComponent(this.urlParams.doctor_id),c="my-msg"===h?this.doctorInfo.headImg:f,"1"===a.type||1===a.type?i=a.content:"2"===a.type||2===a.type?i=chatMessageImage.getCellHtml(a,b):"4"===a.type||4===a.type?i=chatMessageAudio.getCellHtml(a,b):"8"===a.type||8===a.type?i='<video controls="controls" preload="preload" width="240" src="'+(b+a.content.path)+'" type="video/mp4"></video>':"16"===a.type||16===a.type?i=chatRecommend.getRecommondHtml(a):("32"===a.type||32===a.type)&&(i=this.getMedicalHelpHtml(a)),d&&""!==d&&(g+='<header class="current-time"><span>'+d+"</span></header>"),g+='<dl class="'+h+'">',g+=""===h?'<dt><a href="'+e+'"><img src="'+c+'?s=t" width="'+this.chatConfig.iconWidth+'" height="40"/></a></dt>':'<dt><img src="'+c+'?s=t" width="'+this.chatConfig.iconWidth+'" height="40" /></dt>',g+="<dd>"+i+"</dd></dl>",g+="</dl>"},getPatientDefaultIcon:function(a,b){var c="patient_header.png",d=SYS_VAR.STATIC_ADDRESS+"styles/images/patient_default.png",e=b.headImg||"";return a&&""!==a&&"null"!==a&&"undefined"!==a?a.indexOf(c)>=0&&(a=d):a=e&&""!==e&&"null"!==e&&"undefined"!==e?e.indexOf(c)>=0?d:e:d,b.headImg=a,a},getDateString:function(a){return chatTimeFormat.getTimeText(a)},getMedicalHelpHtml:function(a){var b="";b+='<span class="medical-help">',b+=a.content.dest||"",b+="<b>";for(var c=0;c<a.content.keys.length;c++)b+=a.content.keys[c]+(c===a.content.keys.length?"":"、");return b+="</b>",b+="<i>"+a.content.orgin||"</i>",b+="</span>"},doSendTextMessage:function(a,b,c){var d=b.value;return d&&""!==d?/^\s+$/.test(d)?(this.messageBox.show({msg:"不能发送空文本",type:"alert",autoClose:!0}),b.value="",d="",!1):(d=d.trim(),this.combineSendMsgParams(d,1),b.value="",c&&c(!1),void(a&&a.preventDefault())):!1},combineSendMsgParams:function(a,b,c,d,e){var f={},g={};f.from=this.doctorInfo,f.to=this.patientInfo,f.sendTime=(new Date).getTime(),f.relation=1,f.type=b,4===b||2===b?f.content={}:1===b&&(f.content=a),c&&(f.content.media_id=c),d&&(f.content.local_id=d),/^\d+$/.test(e+"")&&(f.content.timeLength=e),f.from.id&&""!==f.from.id&&"0"!==f.from.id||(f.from.id=this.urlParams.doctor_id),f.to.id&&""!==f.to.id&&"0"!==f.to.id||(f.to.id=this.urlParams.patient_id),g.message=f,this.currentSendMessage=g,this.doSaveMessage(g)},doSaveMessage:function(a){var b={sendParameters:{}};b.sendParameters.message=a,b.url=this.chatConfig.chatSaveDoctorMessageServer+"msg_center/h5_api/",b.type="POST",b.asyn=!0,b.onSuccess=this.onSaveMessageSuccess.bind(this),b.onError=this.onSaveMessageError.bind(this),this.isSavingMsgData=!0,this.showSendMessage(),this.ajax.send(b)},onSaveMessageSuccess:function(a){0===a.code||"0"===a.code?this.currentSendMessage={}:this.onSaveMessageError(a),this.isSavingMsgData=!1},onSaveMessageError:function(a){var b="";b="-101"===a.code||-101===a.code?"医生不能主动发起咨询":"-21"===a.code||-21===a.code||"-22"===a.code||-22===a.code?this.getResendMsgHtml():this.getResendMsgHtml(),""!==b&&this.sendSysErrorMessage(b),this.currentSendMessage={},this.isSavingMsgData=!1},getResendMsgHtml:function(){var a,b,c="";return b=encodeURIComponent(JSON.stringify(this.currentSendMessage)),this.currentSendMessage.message.content&&this.currentSendMessage.message.content.length>this.simpleLen&&(c=this.currentSendMessage.message.content.substr(0,this.simpleLen)+"...",c="“"+c+"”"),a="可能由于网络原因，信息"+c+'发送失败<a class="re-send-msg" msg="'+b+'" onclick="chat.doReSendMessage(event);">点击重新发送</a>'},showSendMessage:function(){var a,b,c,d=new Date;a=this.getCellMessageHtml(this.currentSendMessage.message||this.currentSendMessage,this.baseUrl),this.addMessageToPanel(a,!0,null,!0),1!==this.authStatus?(b=window.localStorage.getItem("riskTip"),c=this.urlParams.doctor_id+":"+d.getFullYear()+d.getMonth()+d.getDate(),b&&""!==b&&b===c||(chatCheckUserAuth.showNoVerifyTipMessage(2),window.localStorage.setItem("riskTip",c))):window.localStorage.removeItem("riskTip")},doReSendMessage:function(a){this.currentSendMessage=JSON.parse(decodeURIComponent(a.currentTarget.getAttribute("msg"))),this.currentSendMessage.message.sendTime=(new Date).getTime(),this.doSaveMessage(this.currentSendMessage)},sendSysErrorMessage:function(a){var b,c="";b=this.getDateString((new Date).getTime()),b&&""!==b&&(c='<header class="current-time"><span>'+b+"</span></header>"),
a=c+'<div class="send-msg-failed"><i></i><span>'+a+"</span></div>",this.addMessageToPanel(a,!0,null,!0)},addMessageToPanel:function(a,b,c,d){var e=null;b?c?this.skipPage.appendHtmlNode(a,this.chatPanel,c):(e=document.createElement("span"),e.innerHTML=a,this.chatPanel.appendChild(e)):this.chatPanel.innerHTML=a,this.scrollToMsg(d)},mediaFullScreenView:function(a,b,c){this.fullScreenView.show({type:b,src:a,event:c})},scrollToMsg:function(a){setTimeout(function(){if(a===!0){var b=document.querySelector("#chatMsgList");b.scrollTop=b.scrollHeight-b.clientHeight}},0)},clearCache:function(){window.localStorage&&(window.localStorage.removeItem("patient_id"),window.localStorage.removeItem("doctor_id"),window.localStorage.removeItem("recommondData"))},sendLiveStatusToMsgToServer:function(a){var b={sendParameters:{}},c=a?"chat_api/online/":"chat_api/offline/";return b.sendParameters.patient_id=this.urlParams.patient_id,b.sendParameters.doctor_id=this.urlParams.doctor_id,b.url=this.chatConfig.chatGetHistoryServer+c,b.type="GET",b.asyn=!0,this.ajax.send(b),a===!1&&this.leaveChat(),!1},leaveChat:function(){window.location.href="../patient/patient-admin.html?doctorId="+this.urlParams.doctor_id},showLoading:function(){this.messageBox.show({msg:'<span class="fa fa-spinner fa-pulse fa-2x fa-fw"></span>',type:"loading",autoClose:!1})},hideLoading:function(){this.messageBox.hide()},attachEvent:function(){window.addEventListener("beforeUnload",function(){this.sendLiveStatusToMsgToServer(!1)}.bind(this))}};chat.init();