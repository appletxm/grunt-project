"use strict";var mockIllnessData={code:0,msg:"成功",data:[{stage:"2015-07-08",list:{patientRecords:[{id:9,patientId:49,doctorId:38,record:"很健康",createdAt:"2015-07-08 23:49:02",createdTimeShort:"23:49"}],medicationRecoms:[{id:80,doctorId:38,patientId:49,createdAt:"2015-07-08 23:52:06",createdTimeShort:"23:52",medicationRecomDetails:"强寿 益智康脑丸 广西强寿 3克*12丸*1板 X1"}]}},{stage:"2015-07-08",list:{patientRecords:[{id:9,patientId:49,doctorId:38,record:"很健康",createdAt:"2015-07-08 23:49:02",createdTimeShort:"23:49"}],medicationRecoms:[{id:80,doctorId:38,patientId:49,createdAt:"2015-07-08 23:52:06",createdTimeShort:"23:52",medicationRecomDetails:"强寿 益智康脑丸 广西强寿 3克*12丸*1板 X1"}]}}]},patientIllnessNote={requestUrl:SYS_VAR.SERVER_ADDRESS,messageBox:null,ajax:null,urlParams:{},patientId:null,stages:[],init:function(){this.messageBox=new MessageBox,this.ajax=new Ajax,this.getParamsFromUrl(),this.getIllnessList()},getParamsFromUrl:function(){var a=window.location.search;this.urlParams=a.getValueFromUrl(),this.patientId=this.urlParams.patient_id,this.patientId=parseInt(this.patientId,10),this.urlParams=decodeURIComponent(window.localStorage.getItem("patientInfo")),this.urlParams=JSON.parse(this.urlParams),this.setOpenChatButton()},getIllnessList:function(){var a=this,b={url:SYS_VAR.SERVER_ADDRESS+"doc/patient_mark/",type:"GET",asyn:!0,onSuccess:a.handleGetInfoSuccess.bind(a),onError:a.handleError.bind(a),sendParameters:{patientId:a.patientId}};this.showLoading(),this.ajax.send(b)},handleGetInfoSuccess:function(a){var b,c,d;if(b=[],c=document.querySelector("#illnessNote"),d='<p class="no-data-tip"></p>',0===a.code){var e=a.data;e&&""!==e&&e.length>0&&e?(b=b.concat(this.getListHtml(e)),c.innerHTML=b.join("")):this.showNoDateTip(c,d),this.hideLoading()}else this.handleError(a)},getListHtml:function(a){var b=[],c=this;return a.forEach(function(a){b=b.concat(c.getCellHtml(a))}),b},getCellHtml:function(a){var b,c=[],d=a.stage,e=d.split("-"),f=a.list.patientRecords,g=a.list.medicationRecoms;return b=e[0]+"_"+e[1],this.stages.indexOf("stage_"+b)<0&&(this.stages.push("stage_"+b),c.push('<h6 id="stage_'+b+'">'+e[0]+"年"+e[1]+"月</h6>")),c.push("<ul>"),c.push("<li>"),f&&f.length>0&&f.forEach(function(a){c.push('<p class="time">'+e[1]+"-"+e[2]+" "+a.createdTimeShort+"</p>"),c.push('<p class="note" record-id="'+a.id+'" doctor-id="'+a.doctorId+'"  patient-id="'+a.patientId+'">'+a.record+"</p>")}),g&&g.length>0&&g.forEach(function(a){(!f||f.length<=0)&&c.push('<p class="time">'+e[1]+"-"+e[2]+" "+a.createdTimeShort+"</p>"),c.push('<p recommend-id="'+a.id+'" doctor-id="'+a.doctorId+'"  patient-id="'+a.patientId+'">'+a.medicationRecomDetails+"</p>")}),c.push("</li>"),c.push("</ul>"),c},showNoDateTip:function(a,b){a.innerHTML=b},handleError:function(a){var b=a.msg;""!==b&&b||(b="网络异常，请稍后再试"),this.messageBox.show({msg:b,type:"alert",autoClose:!0})},setOpenChatButton:function(){var a=this.urlParams,b="../chat/chat.html",c=document.querySelectorAll("footer")[0];b+="?patient_id="+encodeURIComponent(a.patient_id),b+="&patient_name="+encodeURIComponent(a.patient_name),b+="&patient_icon="+encodeURIComponent(a.patient_icon),b+="&doctor_id="+encodeURIComponent(a.doctor_id),c.innerHTML='<a href="'+b+'">发送消息</a>'},showLoading:function(){this.messageBox.show({msg:'<span class="fa fa-spinner fa-pulse fa-2x fa-fw"></span>',type:"loading",autoClose:!1})},hideLoading:function(){this.messageBox.hide()}};patientIllnessNote.init();