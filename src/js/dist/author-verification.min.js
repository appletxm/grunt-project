"use strict";var mockAuthData={code:0,msg:"成功",data:[{doctorId:11,name:"林林",title:"医师",department:"感染内科",infoStatus:1,authStatus:4,photoUrl:"../../styles/images/ad_0.png",emcardUrl:"../../styles/images/ad_1.png",vocatecerUrl:"",failReason:null}]},authorVerification={ajax:null,messageBox:null,uploadImage:null,fullScreenViewer:null,serverAddress:SYS_VAR.SERVER_ADDRESS,authStatusMsg:{code_0:"审核中",code_1:"已认证",code_2:"认证失败",code_3:"再次认证",code_4:"未认证"},oldImageInfo:{photoUrl:"",emcardUrl:"",vocatecerUrl:""},modifyImage:{photoUrl:"",emcardUrl:"",vocatecerUrl:""},currentImageNode:null,activeInput:null,totalPhotoNumber:0,totalLoadTimes:0,init:function(){this.ajax=new Ajax,this.messageBox=new MessageBox,this.fullScreenView=new FullScreenView,this.uploadImage=new UploadImage({fileMemory:20,fileType:["jpeg","png","gif"],fileSize:{width:500,height:400},dip:.3,messageBox:this.messageBox}),this.getUserVerifyImages(),this.attachEvent()},getUserVerifyImages:function(){var a={sendParameters:{}};a.url=this.serverAddress+"doc/user_auth_data/",a.type="GET",a.asyn=!0,a.onSuccess=this.handleGetUserImagesSuccess.bind(this),a.onError=this.handleGetUserImagesError.bind(this),this.showLoading(),this.ajax.send(a)},handleGetUserImagesSuccess:function(a){if(0===a.code){if(this.hideLoading(),1!==a.data[0].infoStatus&&"1"!==a.data[0].infoStatus)return void(document.querySelectorAll(".tip-for-upload")[0].style.display="block");document.querySelectorAll(".tip-for-upload")[0].style.display="none",document.querySelectorAll(".tip-msg-fixed")[0].style.display="block",document.querySelector("#uploadImagePanel").style.display="block",document.querySelector("#saveVerityImages").style.display="block",document.querySelector("#authorStatusText").style.display="block",this.showStatusText(a.data[0].authStatus),this.showImageList(a.data[0])}else this.handleGetUserImagesError(a)},handleGetUserImagesError:function(a){var b=a.msg;b&&""!==b||(b="网络异常，请稍后再试"),this.messageBox.show({msg:b,type:"alert",autoClose:!0})},showImageList:function(a){var b,c=document.querySelectorAll("#uploadImagePanel dd");c[0].innerHTML=this.getImageCellHtml(a.photoUrl,"uploadPersonImage","photoUrl"),c[1].innerHTML=this.getImageCellHtml(a.emcardUrl,"uploadWorkImage","emcardUrl"),c[2].innerHTML=this.getImageCellHtml(a.vocatecerUrl,"uploadQualityImage","vocatecerUrl"),b=1!==a.authStatus&&0!==a.authStatus,this.setPreloadImage(a.photoUrl,a.emcardUrl,a.vocatecerUrl),this.canEditImage(b)},showStatusText:function(a){var b=this.authStatusMsg["code_"+a];b=b?"认证状态：<b>"+b+"</b>":"",document.querySelector("#authorStatusText").innerHTML=b},getImageCellHtml:function(a,b,c){var d=[];return a&&""!==a&&"null"!==a&&"undefined"!==a?(this.totalPhotoNumber++,d.push("<b>"),d.push('<img src="'+a+'" width="100px" />'),d.push('<a class="but but-delete-orange" imgType="'+c+'"></a>'),d.push("</b>"),d.push('<span style="display:none;">'),d.push('<a class="but but-only-border">上传图片</a>'),d.push('<input id="'+b+'" type="file" accept="image/*" capture="camera" imgType="'+c),d.push('" onchange="authorVerification.handleInputFileChange(event);"/>'),d.push("</span>")):(d.push('<b style="display:none;">'),d.push('<img src="../../../../styles/images/blank.png" width="100px"/>'),d.push('<a class="but but-delete-orange" imgType="'+c+'"></a>'),d.push("</b>"),d.push("<span>"),d.push('<a class="but but-only-border">上传图片</a>'),d.push('<input id="'+b+'" type="file" accept="image/*" capture="camera" imgType="'+c),d.push('" onchange="authorVerification.handleInputFileChange(event);"/>'),d.push("</span>")),d.join("")},setPreloadImage:function(a,b,c){var d=document.querySelector("#preLoadImageDiv"),e="";e+='<img src="'+a+'" id="pImg_photoUrl" onload="authorVerification.handleImgLoadEvent();"/>',e+='<img src="'+b+'" id="pImg_emcardUrl" onload="authorVerification.handleImgLoadEvent();"/>',e+='<img src="'+c+'" id="pImg_vocatecerUrl" onload="authorVerification.handleImgLoadEvent();"/>',d.innerHTML=e},handleImgLoadEvent:function(){this.totalLoadTimes++,this.totalLoadTimes===this.totalPhotoNumber&&this.getImageDataUrlFromCanves()},getImageDataUrlFromCanves:function(){var a,b=document.querySelectorAll("#preLoadImageDiv img"),c=0;if(b.length<=0)return!1;a=[{canvas:null,url:this.oldImageInfo.photoUrl,img:b[0]},{canvas:null,url:this.oldImageInfo.emcardUrl,img:b[1]},{canvas:null,url:this.oldImageInfo.vocatecerUrl,img:b[2]}],a[0].canvas=document.createElement("canvas"),a[1].canvas=document.createElement("canvas"),a[2].canvas=document.createElement("canvas"),a[0].canvas.setAttribute("id","photoUrl"),a[1].canvas.setAttribute("id","emcardUrl"),a[2].canvas.setAttribute("id","vocatecerUrl");try{for(var d=0;d<a.length;d++){var e=a[d].img,f=a[d].canvas;a[d].url;c++,e.setAttribute("crossOrigin","Anonymous"),f.width=e.naturalWidth,f.height=e.naturalHeight,f.getContext("2d").drawImage(e,0,0,e.naturalWidth,e.naturalHeight,0,0,e.naturalWidth,e.naturalHeight),this.oldImageInfo[f.getAttribute("id")]=f.toDataURL("image/jpeg",1),this.modifyImage[f.getAttribute("id")]=f.toDataURL("image/jpeg",1),c===this.totalPhotoNumber&&this.destroyImagePreLoadCanvas(a)}}catch(g){alert(g)}},destroyImagePreLoadCanvas:function(a){for(var b=document.querySelector("#preLoadImageDiv"),c=0;c<a.length;c++)b.appendChild(a[c].canvas),a[c].img.onload=null;document.querySelectorAll("body")[0].removeChild(b)},handleInputFileChange:function(a){this.currentImageNode=a.target.parentNode.parentNode.querySelectorAll("img")[0],this.activeInput=a.target,this.uploadImage.checkImage(a.target.files,this.currentImageNode,this.afterImageCheckCallback.bind(this))},afterImageCheckCallback:function(a){a&&(this.activeInput.parentNode.style.display="none",this.currentImageNode.parentNode.style.display="block",this.modifyImage[this.activeInput.getAttribute("imgType")]=a),this.activeInput.files=null,this.currentImageNode=null,this.activeInput=null},handleClick:function(a){var b=a.target.tagName.toLowerCase();"a"===b?(this.deleteImage(a.target),a.stopPropagation()):"img"===b&&(this.imageBigView(a.target,a),a.stopPropagation())},deleteImage:function(a){var b=a.parentNode,c=b.nextSibling,d=c.innerHTML;c.innerHTML="",c.innerHTML=d,this.modifyImage[a.getAttribute("imgType")]="",b.style.display="none",c.style.display="block"},doSaveVerifyImages:function(){var a=this.validateImages();if(a){var b={sendParameters:{}};for(var c in this.modifyImage)b.sendParameters[c]=this.modifyImage[c];b.url=this.serverAddress+"doc/up_licence/",b.type="POST",b.asyn=!0,b.onSuccess=this.handleSaveImagesSuccess.bind(this),b.onError=this.handleSaveImagesError.bind(this),b.needPostJson=!0,b.mssage=this.messageBox,b.sendParameters.phoneFile=b.sendParameters.photoUrl,b.sendParameters.emCardFile=b.sendParameters.emcardUrl,b.sendParameters.vocateFile=b.sendParameters.vocatecerUrl,delete b.sendParameters.photoUrl,delete b.sendParameters.emcardUrl,delete b.sendParameters.vocatecerUrl,this.ajax.send(b)}},validateImages:function(){var a=this.modifyImage,b=this.oldImageInfo,c=0,d={photoUrl:"个人图片",emcardUrl:"工作证",vocatecerUrl:"职业资格证"},e=[],f=!0;for(var g in a)a[g]!==b[g]&&c++,(""===a[g]||void 0===a[g]||null===a[g]||"undefined"===a[g]||"null"===a[g])&&e.push(g);if(e.length>0){for(var h="请上传您的",i=0;i<e.length;i++){var j=i===e.length-1?"":"、";h+=d[e[i]]+j}this.messageBox.show({msg:h,type:"alert",autoClose:!0}),f=!1}return 0===c&&(this.messageBox.show({msg:"您的图片还没有任何的修改",type:"alert",autoClose:!0}),f=!1),f},handleSaveImagesSuccess:function(a){0===a.code||"0"===a.code?(this.messageBox.show({msg:"您的图片已提交，请耐心等待我们的审批",type:"alert",autoClose:!0}),this.canEditImage(!1),this.showStatusText(0)):this.handleSaveImagesError(a)},handleSaveImagesError:function(a){this.messageBox.show({msg:a.msg||"",type:"alert",autoClose:!0})},canEditImage:function(a){var b=document.querySelectorAll("#uploadImagePanel .but-delete-orange"),c="";c=a?"block":"none",document.querySelector("#saveVerityImages").style.display=c;for(var d=0;d<b.length;d++)b[d].style.display=c},imageBigView:function(a,b){this.fullScreenView.show({type:1,src:a.getAttribute("src"),event:b})},showLoading:function(){this.messageBox.show({msg:'<span class="fa fa-spinner fa-pulse fa-2x fa-fw"></span>',type:"loading",autoClose:!1})},hideLoading:function(){this.messageBox.hide()},attachEvent:function(){var a=document.querySelector("#uploadImagePanel"),b=document.querySelector("#saveVerityImages");a.addEventListener("click",function(a){this.handleClick(a)}.bind(this),!1),b.addEventListener("click",function(){this.doSaveVerifyImages()}.bind(this),!1)}};authorVerification.init();