var recommend={ajax:null,popWindow:null,messageBox:null,requestUrl:SYS_VAR.SERVER_ADDRESS,recommendList:[],isFromPrescription:null,pageObj:null,init:function(a){a&&(this.pageObj=a.pageObj,this.ajax=a.pageObj.ajax,this.messageBox=a.pageObj.messageBox,this.popWindow=a.pageObj.popWindow),this.attachEvent()},showRecommendBox:function(a,b){var c,d,e,f,g,h,i,j,k=[],l={buttons:[],space:{}};this.isFromPrescription=b,c=a.getAttribute("productId")||"",d=a.getAttribute("skuId")||"",e=decodeURIComponent(a.getAttribute("productName")||""),f=decodeURIComponent(a.getAttribute("commonName")||""),g=decodeURIComponent(a.getAttribute("productSize")||""),h=parseInt(a.getAttribute("hasAddToStore")||0,10),j=decodeURIComponent(a.getAttribute("spec")||""),i=decodeURIComponent(a.getAttribute("usage")||""),l.needMask=!0,l.space={top:10,left:10},k.push('<div class="recommand-tip-box" hasAddToStore="'+h+'" productId="'+c+'" productName="'+(e||"")+'" commonName="'+(f||"")+'" productSize="'+g+'" usage="'+(i||"")+'" skuId="'+d+'">'),f=f&&""!==f?"（"+f+"）":"",k.push("<h1>"+e+f+'<a class="close-pop" onclick="recommend.cancelSelectCallback();"></a></h1>'),k.push('<div class="pro-usage">常规用法：'+i+"</div>"),k.push("<dl>"),k.push("<dt>规格</dt><dd><i>"+j+"</i></dd>"),k.push("</dl>"),k.push("<dl>"),k.push('<dt><span class="red">*</span> 数量</dt>'),k.push("<dd>"),k.push('<span class="number-pick">'),k.push('<input type="button" value="-" onclick="recommend.changeNumber(0, \'medicalNumber\');" />'),k.push('<input id="medicalNumber" oninput="recommend.validateNumber(\'medicalNumber\' ,99);" type="tel" value="1" />'),k.push('<input type="button" value="+" onclick="recommend.changeNumber(1, \'medicalNumber\');" />'),k.push("</span>"),k.push("</dd>"),k.push("</dl>"),k.push('<dl class="gapTop">'),k.push("<dt>一日</dt>"),k.push("<dd>"),k.push('<span class="number-pick">'),k.push('<input type="button" value="-"  onclick="recommend.changeNumber(0, \'timePayDay\');" />'),k.push('<input id="timePayDay" oninput="recommend.validateNumber(\'timePayDay\', 99);" type="tel" value="" />'),k.push('<input type="button" value="+" onclick="recommend.changeNumber(1, \'timePayDay\');" />'),k.push("</span>次"),k.push("</dd>"),k.push("</dl>"),k.push("<dl>"),k.push("<dt>每次</dt>"),k.push("<dd>"),k.push('<span class="number-pick">'),k.push('<input type="button" value="-" onclick="recommend.changeNumber(0, \'timePayUnit\');" />'),k.push('<input id="timePayUnit" oninput="recommend.validateNumber(\'timePayUnit\', 99);" type="tel" value="" />'),k.push('<input type="button" value="+" onclick="recommend.changeNumber(1, \'timePayUnit\');" />'),k.push("</span>"),k.push('<span id="unitList" class="unit-list">'),k.push('<input type="hidden" id="unitText" value="片">'),k.push('<a class="selected" forUnit="片" onclick="recommend.chooseUnit(event, \'片\', \'unitText\');">片</a>'),k.push("<i>"),k.push("<a forUnit=\"粒\" onclick=\"recommend.chooseUnit(event, '粒', 'unitText');\">粒</a>"),k.push("<a forUnit=\"包\" onclick=\"recommend.chooseUnit(event, '包', 'unitText');\">包</a>"),k.push("<a forUnit=\"盒\" onclick=\"recommend.chooseUnit(event, '盒', 'unitText');\">盒</a>"),k.push("<a forUnit=\"单位\" onclick=\"recommend.chooseUnit(event, '单位',  'unitText');\">单位</a>"),k.push("</i>"),k.push("</span>"),k.push("</dd>"),k.push("</dl>"),k.push('<dl class="gapTop">'),k.push('<dt>备注</dt><dd><div class="text-outer"><textarea id="backUp" placeholder="以上的用法用量信息，不进行点选，则不会向患者展示。"></textarea></div></dd>'),k.push("</dl>"),k.push('<a class="do-save-recommond" onclick="recommend.confirmSelectCallback(event, recommend.isFromPrescription);">确定</a>'),k.push("</div>"),l.content=k.join(""),this.showPopWindow(l)},changeNumber:function(a,b,c){var d,e=document.querySelector("#"+b),c=c||99;/^\d+$/.test(e.value)||(e.value=""),d=parseInt(""===e.value?0:e.value,10),0===a?d--:d++,0>=d&&(d="medicalNumber"===b?1:""),d>c&&(d=c),e.value=d},validateNumber:function(a,b){var c,d,e=document.querySelector("#"+a),f="",b=b||99;if(!/^\d+$/.test(e.value))if(d=e.value.match(/\d/g),d&&d.length>=1){for(var g=0;g<d.length;g++)f+=d[g];e.value=f}else"medicalNumber"===a?e.value="1":e.value="";c=parseInt(""===e.value?0:e.value,10),c>b&&(e.value=b)},chooseUnit:function(a,b,c){var d,e;if(a.currentTarget.className.indexOf("selected")<0){e=document.querySelectorAll("#unitList a");for(var f=0;f<e.length;f++)e[f]===a.currentTarget?e[f].className="selected":e[f].className="";d=document.querySelector("#"+c),d.value=b}},confirmSelectCallback:function(a,b){var c={},d=null;c=this.getDataFromHtmlDom(),this.recommendList.map(function(a,b){a.productId===c.productId&&(d=b)}),/^\d+$/.test(d+"")?this.recommendList[d]=c:this.recommendList.push(c),this.toggleCheckMedicineItem(c.productId),this.changeRecommendNumber(this.recommendList.length),this.changeRecommendButtonStatus(),this.hidePopWindow(),b&&b.callBack&&b.callBack(),a&&(a.preventDefault(),a.stopPropagation())},getDataFromHtmlDom:function(){var a,b,c,d,e=document.querySelectorAll(".recommand-tip-box")[0],f={};return b=e.querySelector("#medicalNumber").value,c=e.querySelector("#timePayDay").value,d=e.querySelector("#timePayUnit").value,c&&""!==c&&"0"!==c||(c=0),d&&""!==d&&"0"!==d||(d=0),f.quantity=b,f.timePayDay=c,f.timePayUnit=d,f.unit=e.querySelector("#unitText").value||"",a=e.getAttribute("productId"),f.bakup=e.querySelector("#backUp").value||"",f.commonName=e.getAttribute("commonName")||"",f.productName=e.getAttribute("productName")||"",f.productId=a,f.skuId=e.getAttribute("skuId"),f.spec="",f.combin="",f.hasAddToStore=parseInt(e.getAttribute("hasAddToStore"),10),f},toggleCheckMedicineItem:function(a){var b;b=document.querySelectorAll("span.add-recommond");for(var c=0;c<b.length;c++)parseInt(b[c].getAttribute("productId"),10)===parseInt(a,10)&&(b[c].className="add-recommond selected")},cancelSelectCallback:function(){this.hidePopWindow()},checkHasAddedRecommend:function(a){var b='class="add-recommond"';if(a=parseInt(a,10),this.recommendList.length>0)for(var c=0;c<this.recommendList.length;c++)parseInt(this.recommendList[c].productId,10)===a&&(b='class="add-recommond selected"');return b},doRecommend:function(a){var b={buttons:[],space:{}},c=this.recommendList;return 0===c.length?void this.messageBox.show({msg:"请先选择要推荐的处方单",type:"alert",autoClose:!0}):(this.frozenOrUnFrozenBackground(!0),b.needMask=!0,b.space={height:350,left:20},b.content=this.getRecommendListHtml(c),this.showPopWindow(b),void(a&&a.stopPropagation()))},getRecommendListHtml:function(a){var b,c,d=[];d.push('<div class="recommand-tip-box recommand-list-box">'),d.push('<h1>用药确认<a class="close-pop" onclick="recommend.cancelDoRecommendCallback();"></a></h1>'),d.push('<div class="list-body" id="recommendListBody">'),d.push("<ul>");for(var e=0;e<a.length;e++)a[e].commonName&&""!==a[e].commonName?(b=a[e].productName+"("+a[e].commonName+")",c=a[0].commonName.substr(0,6)+"的处方单"):(b=a[e].productName,c="处方单"),d.push('<li productId="'+a[e].productId+'">'),d.push('<span class="no-gap">'+b+"</span>"),d.push("</li>");return d.push("</ul>"),d.push("</div>"),d.push('<a class="do-save-recommond" onclick="recommend.confirmDoRecommendCallback();">推荐</a>'),d.join("")},deleteItemFromList:function(a,b){a.target.parentNode.style.display="none",this.doDeleteRecommendItem(b,!0)},doDeleteRecommendItem:function(a,b){for(var c,d=0;d<this.recommendList.length;d++)this.recommendList[d].productId==a&&this.recommendList.splice(d,1);if(this.changeRecommendNumber(this.recommendList.length),this.changeRecommendButtonStatus(),b===!0){c=document.querySelectorAll("span.add-recommond");for(var d=0;d<c.length;d++)parseInt(c[d].getAttribute("productId"),10)===parseInt(a,10)&&(c[d].className="add-recommond")}},popDoAddToStore:function(a,b){},showUsageDropDownList:function(a){var b=document.querySelector("#"+a);b.style.display="block"},changeUsage:function(a,b){var c=document.querySelector("#"+b);c.innerHTML=a.target.innerHTML,a.currentTarget.style.display="none"},cancelDoRecommendCallback:function(){this.frozenOrUnFrozenBackground(!1),this.hidePopWindow()},confirmDoRecommendCallback:function(){return this.frozenOrUnFrozenBackground(!1),this.recommendList.length<=0?(this.hidePopWindow(),!1):void this.sendRecommendDataToChat()},savePrescription:function(a){for(var b=[],c={sendParameters:{name:a}},d=0;d<this.recommendList.length;d++)b.push(this.recommendList[d].productId);c.sendParameters.medicationIds=b.join(","),c.url=this.requestUrl+"doc/medication_quick_add",c.type="GET",c.asyn=!0,c.onSuccess=this.handleSavePrescriptionSuccess.bind(this),c.onError=this.mainPageObj.handleGetError.bind(this),this.ajax.send(c),this.mainPageObj.showLoading()},handleSavePrescriptionSuccess:function(a){0===a.code||"0"===a.code?this.sendRecommendDataToChat():this.mainPageObj.handleGetError(a)},sendRecommendDataToChat:function(){var a=JSON.stringify(this.recommendList);window.localStorage.setItem("recommondData",encodeURIComponent(a)),window.location.href=this.requestUrl+"static/templates/chat/chat.html",this.hidePopWindow()},getRecommendListFromPrescription:function(a){for(var b in a)if(/^\d+$/.test(b)){var c={},d=a[b];c.productId=decodeURIComponent(d.getAttribute("productId")),c.productName=decodeURIComponent(d.getAttribute("productName")),c.commonName=decodeURIComponent(d.getAttribute("commonName")),this.recommendList.push(c)}this.changeRecommendNumber(this.recommendList.length),this.changeRecommendButtonStatus()},changeRecommendButtonStatus:function(){var a=this.recommendList,b=document.querySelector("#recommandMedical"),c="recommand-but";a.length>0&&(c+=" actived"),b.className=c},changeRecommendNumber:function(a){document.querySelector("#recommandNumber").innerHTML=a},frozenOrUnFrozenBackground:function(a){var b="overflow:hidden!important;",c=document.querySelector("#prescriptionScroll"),d=document.documentElement.clientHeight;b+="height:"+d+"px!important;",a===!0?c.setAttribute("style",b):c.removeAttribute("style")},showPopWindow:function(a){this.popWindow.show(a)},hidePopWindow:function(){this.popWindow.hide()},attachEvent:function(){}};recommend.init();var mock_prescription={data:[{id:3,doctorId:1,name:"分组",medicationIds:"16495,10049,7044",createdAt:"2015-06-23 23:24:48",changedAt:null},{id:3,doctorId:1,name:"分组",medicationIds:"16495,10049,7044",createdAt:"2015-06-23 23:24:48",changedAt:null}],msg:"success",code:0},mock_p_detail={data:[{id:1107,name:"【999】三九感冒灵胶囊 12粒",commonName:"感冒灵胶囊",spec:"6g装",usage:"口服，一次2粒，一日3次。",image:"http://img.7lk.com_1.jpg",salePrice:"10.90",marketPrice:"13.08",addNum:0,added:!1,skus:[{skuId:15511,name:"999感冒灵胶囊",salePrice:"10.90",prescribed:!1}],prescribed:!1},{id:1107,name:"【999】三九感冒灵胶囊 12粒",commonName:"感冒灵胶囊",spec:"6g装",usage:"口服，一次2粒，一日3次。",image:"http://img.7lk.com_1.jpg",salePrice:"10.90",marketPrice:"13.08",addNum:0,added:!1,skus:[{skuId:15511,name:"999感冒灵胶囊",salePrice:"10.90",prescribed:!1}],prescribed:!1}],msg:"success",code:0},prescriptionRecommend={ajax:null,popWindow:null,messageBox:null,requestUrl:SYS_VAR.SERVER_ADDRESS,selectedList:null,completedTimes:0,currentPrescription:null,urlParams:{},init:function(a){this.ajax=new Ajax,this.messageBox=new MessageBox,this.popWindow=new PopWindow,recommend.init({pageObj:prescriptionRecommend}),this.getUrlParams(),this.getPrescription(),this.attachEvent()},getUrlParams:function(){var a=window.location.search.replace("?","");this.urlParams=a.getValueFromUrl()},getPrescription:function(){var a={sendParameters:{}};a.url=this.requestUrl+"doc/medication_group_list/",a.type="GET",a.asyn=!0,a.onSuccess=this.handleGetPrescriptionSuccess.bind(this),a.onError=this.handleGetError.bind(this),this.ajax.send(a),this.showLoading()},handleGetPrescriptionSuccess:function(a){0===a.code||"0"===a.code?(this.showPrescriptionList(a.data),this.hideLoading()):this.handleGetError(a)},showPrescriptionList:function(a){var b,c=document.querySelector("#myPrescriptionList");0===a.length?b='<p class="no-data-tip"></p>':(b=this.getPrescriptionHtml(a),document.querySelector("#chooseTipMsg").style.display="block"),c.innerHTML=b},getPrescriptionHtml:function(a){for(var b=[],c=0;c<a.length;c++){var d,e;e=a[c].medicationIds,d=e&&""!==e&&"undefined"!==e&&"null"!==e?e.split(","):[],b.push('<h2 id="'+a[c].id+'" medicationIds="'+a[c].medicationIds+'" class="after-arrow">'),b.push('<span class="radio-dot send-prescription"'),b.push(' prescrition-id="'+a[c].id+'"'),b.push(' for="myPrescription_'+a[c].id+'"'),b.push(' number="'+d.length+'"'),b.push(">"),b.push("</span>"),b.push("<i>"+a[c].name+"</i><b>("+d.length+")</b>"),b.push("</h2>"),b.push('<div id="myPrescription_'+a[c].id+'" class="product-list"></div>')}return b.join("")},openOrClosePrescriptDetail:function(a,b){var c;b.innerHTML&&""!==b.innerHTML?(c=a.className,c.indexOf("selected")>=0?(a.className=a.className.replace(" selected",""),b.style.display="none"):(b.style.display="block",a.className=a.className+" selected")):(this.loadMedicineForPrescription(parseInt(a.getAttribute("id"),10),b),a.className=a.className+" selected")},loadMedicineForPrescription:function(a,b,c){var d={sendParameters:{id:a}};d.url=this.requestUrl+"doc/medication_group_detail",d.type="GET",d.asyn=!0,d.onSuccess=function(a){this.handleGetPrescriptionDetailSuccess(a,b,c)}.bind(this),d.onError=this.handleGetError.bind(this),this.ajax.send(d),this.showLoading()},handleGetPrescriptionDetailSuccess:function(a,b,c){0===a.code||"0"===a.code?(this.showPrescriptionDetail(a.data,b),this.hideLoading(),c&&c(this.currentPrescription,b)):this.handleGetError(a)},showPrescriptionDetail:function(a,b){var c;c=this.getListHtml(a),b.innerHTML=c,b.style.display="block"},sendPrescription:function(a){var b=document.querySelector("#"+a.getAttribute("for")),c=parseInt(a.getAttribute("number"),10),d=parseInt(a.getAttribute("prescrition-id"),10);this.currentPrescription=a,this.selectedList=b.querySelectorAll("span"),c>0&&(this.selectedList.length>0?this.togglePrescriptionCheck(a):this.loadMedicineForPrescription(d,b,function(a,b){this.togglePrescriptionCheck(a,b),this.openOrClosePrescriptDetail(a.parentNode,a.parentNode.nextElementSibling)}.bind(this)))},togglePrescriptionCheck:function(a,b){var c=!1,d=document.querySelectorAll("#myPrescriptionList h2 span");for(var e in d)/^\d+$/.test(e)&&(d[e]===a?a.className.indexOf("selected")>=0?(a.className=a.className.replace(" selected",""),c=!1):(a.className=a.className+" selected",c=!0):d[e].className=d[e].className.replace(" selected",""));b&&(this.selectedList=b.querySelectorAll("span")),recommend.recommendList=[],c===!0?this.addToRecommendBox():(this.selectedList=null,this.currentPrescription=null,recommend.changeRecommendButtonStatus(),recommend.changeRecommendNumber(0))},showRecommendBox:function(a){this.selectedList&&this.selectedList.length>=0?recommend.showRecommendBox(this.selectedList[this.completedTimes],{callBack:this.confirmSendPrescription.bind(this)}):this.messageBox.show({msg:"请先选择要推荐的处方单",type:"alert",autoClose:!0}),a&&a.stopPropagation()},addToRecommendBox:function(){var a=this.selectedList;recommend.getRecommendListFromPrescription(a)},confirmSendPrescription:function(){this.completedTimes===this.selectedList.length-1?(recommend.doRecommend(),recommend.isFromPrescription=null,this.completedTimes=0):(this.completedTimes++,this.showRecommendBox())},getListHtml:function(a){for(var b=[],c=0;c<a.length;c++){var d,e,f,g="添加到常用药",h="add-store",i=a[c].skus[0].skuId,j=[];1==a[c].added&&(g="已经添加",h="add-store add-store-success"),e=a[c].name&&""!==a[c].name&&"null"!==a[c].name&&"undefined"!==a[c].name?a[c].name:"药品",a[c].commonName&&""!==a[c].commonName&&"null"!==a[c].commonName&&"undefined"!==a[c].commonName&&(e+="（"+a[c].commonName+"）"),d=recommend.checkHasAddedRecommend(a[c].id),f='onclick="prescriptionRecommend.handleSearchListClick(event);"',j.push('<span style="display:none;" '+d),j.push(' hasAddToStore="0" productId="'+a[c].id+'"'),j.push(' usage="'+encodeURIComponent(a[c].usage||"")+'"'),j.push(' spec="'+encodeURIComponent(a[c].spec||"")+'"'),j.push(' skuId="'+i+'"'),j.push(' productSize="'+encodeURIComponent(a[c].usage||"")+'"'),j.push(' productName="'+encodeURIComponent(a[c].name||"")+'"'),j.push(' commonName="'+encodeURIComponent(a[c].commonName||"")+'"></span>'),b.push("<dl "+f+' url="../medical/medical-detail.html?medicalId='+a[c].id+"&isAdded="+(a[c].added||!0)+'">'),b.push('<dt><a><img src="'+a[c].image+'?s=t" width="100" /></a></dt>'),b.push("<dd>"),b.push('<i class="tit">'+e+"</i>"),b.push('<i class="size">'+(a[c].manufacturer||a[c].usage)+"</i>"),b.push("<b>¥"+a[c].salePrice+"</b>"),b.push(j.join("")),b.push("</dd>"),b.push("</dl>")}return b.join("")},handleSearchListClick:function(a){var b=a.currentTarget;window.location.href=b.getAttribute("url"),a.preventDefault(),a.stopPropagation()},handlePanelClick:function(a){var b,c=a.target,d=c.tagName.toLowerCase();"h2"===d||"i"===d||"b"===d?(("i"===d||"b"===d)&&(c=c.parentNode),b=/\d+/.exec(c.querySelectorAll("b")[0].innerHTML),b=b?parseInt(b,10):0,b>0&&(this.openOrClosePrescriptDetail(c,c.nextElementSibling),a.preventDefault(),a.stopPropagation())):"span"===d&&c.className.indexOf("send-prescription")>=0&&(this.sendPrescription(c),a.preventDefault(),a.stopPropagation())},handleGetError:function(a){var b=a.msg;a.msg&&""!==a.msg||(b="网络异常，请稍后再试"),this.messageBox.show({msg:b,type:"alert",autoClose:!0})},showLoading:function(){this.messageBox.show({msg:'<span class="fa fa-spinner fa-pulse fa-2x fa-fw"></span>',type:"loading",autoClose:!1})},hideLoading:function(){this.messageBox.hide()},attachEvent:function(){var a=document.querySelector("#myPrescriptionList"),b=document.querySelector("#recommandMedical");a.onclick=function(a){this.handlePanelClick(a)}.bind(this),b.addEventListener("click",function(a){this.showRecommendBox(a)}.bind(this))}};prescriptionRecommend.init();